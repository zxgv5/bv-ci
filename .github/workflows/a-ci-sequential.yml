name: a-ci-sequential

on:
  workflow_dispatch:
  release:
    types: [published, created]

env:
  ARTIFACT_DIR: artifacts

jobs:
  # 串行构建每个APK
  build-apks:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app: [acode, fantasybv, frost819bv, materialfiles, piliplus, termux, xed-editor]
        include:
          - app: acode
            workflow: build-acode.yml
          - app: fantasybv
            workflow: build-fantasytyx-bv.yml
          - app: frost819bv
            workflow: build-frost819-bv.yml
          - app: materialfiles
            workflow: build-materialfiles.yml
          - app: piliplus
            workflow: build-bggrgjqaubcoe-piliplus.yml
          - app: termux
            workflow: build-termux.yml
          - app: xed-editor
            workflow: build-xed-editor.yml
      max-parallel: 1  # 关键：确保串行执行
      fail-fast: false  # 即使某个构建失败，继续执行其他构建

    steps:
      - name: Clean runner environment
        run: |
          # 清理可能存在的全局缓存文件
          rm -rf ~/.gradle/caches/transforms-*
          rm -rf ~/.android/build-cache/

      - name: Checkout source repo
        uses: actions/checkout@main

      - name: Trigger ${{ matrix.app }} build
        uses: benc-uk/workflow-dispatch@master
        with:
          workflow: ${{ matrix.workflow }}
          token: ${{ secrets.GITHUB_TOKEN }}
          wait: true


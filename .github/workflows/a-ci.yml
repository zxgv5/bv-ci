name: a-ci-sequential

on:
  workflow_dispatch:
  release:
    types: [published, created]

env:
  ARTIFACT_DIR: artifacts

jobs:
  # 串行构建每个APK
  build-apks:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app: [acode, fantasybv, frost819bv, materialfiles, piliplus, termux, xed-editor]
        include:
          - app: acode
            workflow: build-acode.yml
          - app: fantasybv
            workflow: build-fantasytyx-bv.yml
          - app: frost819bv
            workflow: build-frost819-bv.yml
          - app: materialfiles
            workflow: build-materialfiles.yml
          - app: piliplus
            workflow: build-bggrgjqaubcoe-piliplus.yml
          - app: termux
            workflow: build-termux.yml
          - app: xed-editor
            workflow: build-xed-editor.yml
      max-parallel: 1  # 关键：确保串行执行
      fail-fast: false  # 即使某个构建失败，继续执行其他构建

    steps:
      - name: Checkout source repo
        uses: actions/checkout@main

      - name: Trigger ${{ matrix.app }} build
        uses: benc-uk/workflow-dispatch@master
        with:
          workflow: ${{ matrix.workflow }}
          token: ${{ secrets.GITHUB_TOKEN }}
          wait: true

      - name: Download ${{ matrix.app }} apk
        uses: dawidd6/action-download-artifact@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: ${{ matrix.workflow }}
          name: ${{ matrix.app }}.apk
          path: ${{ env.ARTIFACT_DIR }}
        continue-on-error: true

      - name: Upload ${{ matrix.app }} apk as intermediate artifact
        uses: actions/upload-artifact@main
        if: success() || failure()  # 即使下载失败也继续
        with:
          name: ${{ matrix.app }}-apk
          path: ${{ env.ARTIFACT_DIR }}/${{ matrix.app }}.apk
          retention-days: 1

  # 打包和发布阶段
  package-release:
    needs: build-apks  # 等待所有构建完成
    runs-on: ubuntu-latest
    if: always()  # 即使某些构建失败也执行打包

    steps:
      - name: Checkout repository
        uses: actions/checkout@main

      - name: Download all apk artifacts
        uses: actions/download-artifact@main
        with:
          path: ${{ env.ARTIFACT_DIR }}
          pattern: *-apk
          merge-multiple: true

      - name: List downloaded apk files
        run: |
          echo "Available APKs:"
          find ${{ env.ARTIFACT_DIR }} -name "*.apk" 2>/dev/null || true
          count=$(find ${{ env.ARTIFACT_DIR }} -name "*.apk" 2>/dev/null | wc -l || echo "0")
          echo "Total APKs found: $count"

      - name: Create zip archive
        run: |
          cd ${{ env.ARTIFACT_DIR }}
          # 确保目录中有文件才打包
          if ls *.apk 1> /dev/null 2>&1; then
            zip -r ../all_apks.zip ./*.apk
            echo "? ZIP created successfully"
          else
            echo "?? No APK files found for packaging"
            # 创建空ZIP避免后续步骤失败
            touch empty.zip
            zip -r ../all_apks.zip empty.zip
            rm empty.zip
          fi

      - name: Publish to release
        uses: softprops/action-gh-release@master
        with:
          tag_name: apk-bundle-${{ github.run_id }}
          name: "apk bundle v${{ github.run_number }}"
          files: all_apks.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

#构建android app的一般流程
name: android-build-ci-template
on:
  workflow_dispatch:
  workflow_call:
env:
  # ANDROID_COMMANDLINETOOLS: 'commandlinetools-linux-9477386_latest.zip'
  ANDROID_COMPILE_SDK: '36'
  ANDROID_BUILD_TOOLS: '36.0.0'
  ANDROID_COMMANDLINETOOLS: 'commandlinetools-linux-13114758_latest.zip'
  JDK_VERSION: '21'
  JDK_DISTRIBUTION: 'temurin'
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Clean runner environment
        run: |
          # 清理可能存在的全局缓存文件
          rm -rf ~/.gradle/caches/transforms-*
          rm -rf ~/.android/build-cache/

      - name: Checkout source repo
        uses: actions/checkout@main
        with:
          repository: author_xxx/repo_xxx
          ref: main_xxx
          path: repo_xxx_source
          fetch-depth: 0

      - name: Initialization values
        run: |
          echo "BUILD_DATE=$(TZ=UTC-8 date +"%y.%m.%d-%H.%M.%S")" >> $GITHUB_ENV

      - name: Set up jdk
        uses: actions/setup-java@main
        with:
          java-version: "${{ env.JDK_VERSION }}"
          distribution: "${{ env.JDK_DISTRIBUTION }}"

      # 由于android-actions/setup-android已停更较长时间
      # 不再建议使用android-actions/setup-android来安装android sdk
      # 用下面的手动实现
      - name: Set up android sdk
        run: |
          # 1. 下载并解压命令行工具
          cd $HOME
          wget -q https://dl.google.com/android/repository/"${{ env.ANDROID_COMMANDLINETOOLS }}"
          mkdir -p android-sdk/cmdline-tools
          unzip -q "${{ env.ANDROID_COMMANDLINETOOLS }}" -d android-sdk/cmdline-tools
          mv android-sdk/cmdline-tools/cmdline-tools android-sdk/cmdline-tools/latest

          # 2. 设置SDK根目录环境变量
          echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV

          # 3. 接受SDK许可证
          yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses > /dev/null

          # 4. 安装指定的平台和构建工具 (此时创建platform-tools等目录)
          $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --install \
            "platforms;android-${{ env.ANDROID_COMPILE_SDK }}" \
            "build-tools;${{ env.ANDROID_BUILD_TOOLS }}" \
            "platform-tools"

          # 5. 将安装好的工具目录加入PATH (所有组件已就绪)
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/build-tools/${{ env.ANDROID_BUILD_TOOLS }}" >> $GITHUB_PATH

      # - name: Decode and write release keystore
      #   # working-directory: ./frost819-bv-source
      #   run: |
      #     echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > keystore.p12
      #     # 同时，创建一个虚拟的debug密钥库文件（例如，直接复制一份release的，或创建一个空文件）
      #     # 这里选择复制，以确保它是一个有效的文件
      #     cp keystore.p12 debug.keystore

      # - name: Write signing.properties for release build
      #   # working-directory: ./frost819-bv-source
      #   run: |
      #     cat <<EOF > signing.properties
      #     releaseStoreFile=keystore.p12
      #     releaseKeyAlias=${{ secrets.KEY_ALIAS }}
      #     releaseStorePassword=${{ secrets.KEYSTORE_PASSWORD }}
      #     releaseKeyPassword=${{ secrets.KEY_ALIAS_PASSWORD }}
      #     EOF

      - name: Build with Gradle
        run: ./gradlew assembleRelease

      - name: Erase keystore, encrypt package and create release
        uses: ./ci_source/.github/actions/erase_aes256pac_release/
        with:
          # 私钥文件路径（基于github.workspace的绝对路径）
          P12_KEYSTORE_PATH: "./xxx/keystore.p12"
          ZIP_AES256_PWD: ${{ secrets.ZIP_AES256_PWD }}
          BUILD_ARTIFACT_PATH: "./xxx/release/xxx-${{ env.BUILD_DATE }}.apk"
          RELEASE_TAG_NAME: "${{ env.BUILD_DATE }}-xxx"
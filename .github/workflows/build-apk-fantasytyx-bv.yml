name: build-apk-fantasytyx-bv

on:
  workflow_dispatch:
    inputs:
      incremental_build:
        description: 'æ˜¯å¦å¯ç”¨å¢é‡æ„å»ºï¼ˆä»…é‡æ–°æ„å»ºä¿®æ”¹è¿‡çš„ä»£ç ï¼‰'
        type: choice
        required: true
        default: 'true'
        options:
          - 'true'
          - 'false'
  workflow_call:
    inputs:
      incremental_build:
        description: 'æ˜¯å¦å¯ç”¨å¢é‡æ„å»º'
        type: string
        required: false
        default: 'true'

env:
  JDK_VERSION: '21'
  ANDROID_COMPILE_SDK: '36'
  ANDROID_BUILD_TOOLS: '36.0.0'
  GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Show build configuration
        run: |
          echo "=== æ„å»ºé…ç½® ==="
          echo "å¢é‡æ„å»ºæ¨¡å¼: ${{ inputs.incremental_build }}"
          echo "Runner: ${{ runner.os }}"

      # æ£€å‡ºciä»“åº“
      - name: Checkout ci source repo (self)
        uses: actions/checkout@main
        with:
          path: ci_source

      # å¹¶è¡Œå…‹éš†ä¸¤ä¸ªä»“åº“
      - name: Checkout source repo (fantasy-bv)
        uses: actions/checkout@main
        with:
          repository: fantasytyx/bv
          ref: develop
          path: fantasy-bv-source
          fetch-depth: 0

      - name: Checkout pre-built libs repo (bv-libs)
        uses: actions/checkout@main
        with:
          repository: zxgv5/bv-libs
          token: ${{ secrets.BV_LIBS_ACCESS_TOKEN }}
          ref: main
          path: bv-libs-source

      # ç¯å¢ƒå˜é‡åˆå§‹åŒ–
      - name: Initialization values
        run: |
          echo "BUILD_DATE=$(TZ=UTC-8 date +"%y.%m.%d-%H.%M.%S")" >> $GITHUB_ENV
          echo "INCREMENTAL_BUILD_MODE=${{ inputs.incremental_build }}" >> $GITHUB_ENV

      # å…ˆè¿è¡Œcustomizeè„šæœ¬
      - name: Customize scripts
        run: |
          echo "=== è¿è¡Œcustomizeè„šæœ¬ ==="
          chmod +x $GITHUB_WORKSPACE/ci_source/scripts/customize-bv-fantasy.sh
          $GITHUB_WORKSPACE/ci_source/scripts/customize-bv-fantasy.sh

      # æ¢å¤Gradleç¼“å­˜ï¼ˆä»…å¢é‡æ„å»ºæ¨¡å¼ï¼‰
      - name: Restore Gradle cache
        if: ${{ inputs.incremental_build == 'true' }}
        uses: actions/cache@main
        id: gradle-cache
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            fantasy-bv-source/.gradle
            fantasy-bv-source/.gradle-build-cache
          key: ${{ runner.os }}-gradle-cache-${{ hashFiles('fantasy-bv-source/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-cache-

      # æ¢å¤æºä»£ç å“ˆå¸Œç¼“å­˜ï¼ˆä»…å¢é‡æ„å»ºæ¨¡å¼ï¼‰
      - name: Restore source hash cache
        if: ${{ inputs.incremental_build == 'true' }}
        uses: actions/cache@main
        id: source-hash-cache
        with:
          path: fantasy-bv-source/.incremental
          key: ${{ runner.os }}-source-hash-${{ github.ref_name }}
          restore-keys: |
            ${{ runner.os }}-source-hash-

      # ä»Monorepoåˆå¹¶åº“
      - name: Merge libraries from monorepo structure
        run: |
          echo "=== ä» bv-libs Monorepo å¤åˆ¶å„å­åº“ ==="
          cd fantasy-bv-source
          
          mkdir -p libs
          
          declare -A LIB_PATHS
          LIB_PATHS=(
            ["akDanmaku"]="akDanmaku"
            ["av1Decoder"]="av1Decoder"
            ["ffmpegDecoder"]="ffmpegDecoder"
            ["libVLC"]="libVLC"
            ["media3Container"]="media3Container"
          )
          
          for LIB_NAME in "${!LIB_PATHS[@]}"; do
            SRC_PATH="../bv-libs-source/${LIB_PATHS[$LIB_NAME]}"
            DEST_PATH="libs/$LIB_NAME"
            
            if [ -d "$SRC_PATH" ]; then
              rm -rf "$DEST_PATH"
              cp -r "$SRC_PATH" "$DEST_PATH"
              echo "âœ… å·²å¤åˆ¶åº“: $LIB_NAME"
            else
              echo "âŒ é”™è¯¯ï¼šæºè·¯å¾„ä¸å­˜åœ¨: $SRC_PATH"
              exit 1
            fi
          done
          
          echo "=== åº“åˆå¹¶å®Œæˆ ==="

      # å…³é”®ä¿®å¤ï¼šæ›´æ–°akdanmakuæ¨¡å—çš„æ„å»ºé…ç½®ï¼Œç§»é™¤å·²å¼ƒç”¨çš„é€‰é¡¹
      - name: Fix akdanmaku build configuration
        working-directory: ./fantasy-bv-source
        run: |
          echo "=== ä¿®å¤akdanmakuæ¨¡å—æ„å»ºé…ç½® ==="
          
          # æ£€æŸ¥å¹¶ä¿®å¤akdanmakuæ¨¡å—çš„build.gradleæ–‡ä»¶
          if [ -f "akdanmaku/build.gradle" ]; then
            echo "æ‰¾åˆ°akdanmaku/build.gradleï¼Œä¿®å¤å·²å¼ƒç”¨çš„é€‰é¡¹..."
            
            # ç§»é™¤android.enableBuildCacheé€‰é¡¹ï¼ˆå·²å¼ƒç”¨ï¼‰
            sed -i '/android.enableBuildCache/d' akdanmaku/build.gradle
            
            # æ£€æŸ¥å¹¶æ›´æ–°Android Gradleæ’ä»¶ç‰ˆæœ¬ï¼ˆå¦‚æœéœ€è¦ï¼‰
            if grep -q "com.android.tools.build:gradle:" akdanmaku/build.gradle; then
              echo "æ£€æµ‹åˆ°Android Gradleæ’ä»¶ï¼Œç¡®ä¿ç‰ˆæœ¬å…¼å®¹..."
              # è¿™é‡Œå¯ä»¥æ›´æ–°æ’ä»¶ç‰ˆæœ¬ï¼Œä½†å…ˆä¿æŒåŸæ ·
            fi
            
            echo "ä¿®å¤åçš„build.gradleå‰5è¡Œ:"
            head -5 akdanmaku/build.gradle
          elif [ -f "akdanmaku/build.gradle.kts" ]; then
            echo "æ‰¾åˆ°akdanmaku/build.gradle.ktsï¼Œä¿®å¤å·²å¼ƒç”¨çš„é€‰é¡¹..."
            sed -i '/android.enableBuildCache/d' akdanmaku/build.gradle.kts
          else
            echo "æœªæ‰¾åˆ°akdanmakuæ„å»ºæ–‡ä»¶ï¼Œè·³è¿‡ä¿®å¤"
          fi
          
          # åŒæ—¶ä¿®å¤æ ¹é¡¹ç›®çš„gradle.propertiesï¼Œç§»é™¤å·²å¼ƒç”¨çš„é€‰é¡¹
          if [ -f "gradle.properties" ]; then
            echo "æ›´æ–°gradle.propertiesï¼Œç§»é™¤å·²å¼ƒç”¨çš„é€‰é¡¹..."
            sed -i '/android.enableBuildCache/d' gradle.properties
          fi

      - name: Set up jdk 21
        uses: actions/setup-java@main
        with:
          java-version: ${{ env.JDK_VERSION }}
          distribution: 'temurin'

      # æ£€æŸ¥æºä»£ç å˜æ›´ï¼ˆä»…åœ¨å¢é‡æ„å»ºæ¨¡å¼ï¼‰
      - name: Check source changes for incremental build
        id: check-source-changes
        if: ${{ inputs.incremental_build == 'true' }}
        working-directory: ./fantasy-bv-source
        run: |
          echo "=== å¢é‡æ„å»ºæ¨¡å¼ï¼šæ£€æŸ¥æºä»£ç å˜æ›´ ==="
          
          mkdir -p .incremental
          
          # è®¡ç®—å½“å‰æºä»£ç å“ˆå¸Œ
          echo "è®¡ç®—å½“å‰æºä»£ç å“ˆå¸Œ..."
          
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶åˆ—è¡¨ï¼ˆæ’é™¤æ„å»ºè¾“å‡ºå’Œç¼“å­˜ç›®å½•ï¼‰
          find . -type f \
            \( -name "*.kt" -o -name "*.java" -o -name "*.gradle" -o -name "*.gradle.kts" \
               -o -name "*.xml" -o -name "*.pro" -o -name "*.mk" -o -name "*.txt" \
               -o -name "*.json" -o -name "*.properties" -o -name "*.aar" -o -name "*.jar" \) \
            -not -path "./.git/*" \
            -not -path "./build/*" \
            -not -path "./.gradle/*" \
            -not -path "./.incremental/*" \
            -not -path "./*.apk" \
            -not -path "./keystore.p12" \
            -not -path "./signing.properties" | \
            sort > .incremental/file_list.txt 2>/dev/null || true
          
          # è®¡ç®—æ–‡ä»¶å†…å®¹å“ˆå¸Œ
          if [ -s .incremental/file_list.txt ]; then
            while IFS= read -r file; do
              if [ -f "$file" ]; then
                sha256sum "$file" 2>/dev/null || true
              fi
            done < .incremental/file_list.txt | sha256sum | awk '{print $1}' > .incremental/current_content_hash.txt
          else
            echo "empty" > .incremental/current_content_hash.txt
          fi
          
          CURRENT_HASH=$(cat .incremental/current_content_hash.txt)
          echo "å½“å‰æºä»£ç å†…å®¹å“ˆå¸Œ: $CURRENT_HASH"
          
          # æ£€æŸ¥ä¸Šæ¬¡æ„å»ºå“ˆå¸Œ
          if [ -f ".incremental/previous_content_hash.txt" ]; then
            PREVIOUS_HASH=$(cat .incremental/previous_content_hash.txt)
            echo "ä¸Šæ¬¡æ„å»ºå†…å®¹å“ˆå¸Œ: $PREVIOUS_HASH"
            
            if [ "$CURRENT_HASH" = "$PREVIOUS_HASH" ]; then
              echo "âœ… æºä»£ç å†…å®¹å®Œå…¨ä¸€è‡´ï¼Œå¯ä»¥è·³è¿‡æ„å»º"
              echo "skip_build=true" >> $GITHUB_OUTPUT
            else
              echo "ğŸ”„ æºä»£ç å†…å®¹æœ‰å˜åŒ–ï¼Œéœ€è¦é‡æ–°æ„å»º"
              echo "skip_build=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "ğŸ“ é¦–æ¬¡æ„å»ºæˆ–æœªæ‰¾åˆ°ä¸Šæ¬¡æ„å»ºå“ˆå¸Œ"
            echo "skip_build=false" >> $GITHUB_OUTPUT
          fi
          
          echo "current_content_hash=$CURRENT_HASH" >> $GITHUB_OUTPUT

      # å‡†å¤‡Gradleç¯å¢ƒ
      - name: Prepare gradle environment
        working-directory: ./fantasy-bv-source
        run: |
          chmod +x ./gradlew
          echo "Gradle ç‰ˆæœ¬ä¿¡æ¯:"
          ./gradlew --version
          # æ˜¾ç¤ºå½“å‰gradle.propertiesé…ç½®
          echo "=== gradle.propertiesé…ç½® ==="
          tail -20 gradle.properties

      # ç¼–è¯‘ player.tv æ¨¡å—ï¼ˆæ¡ä»¶æ€§ï¼‰
      - name: Build player.tv module
        if: ${{ inputs.incremental_build == 'false' || steps.check-source-changes.outputs.skip_build != 'true' }}
        working-directory: ./fantasy-bv-source
        run: |
          echo "=== ç¼–è¯‘ player.tv æ¨¡å— ==="
          
          # ä½¿ç”¨--build-cacheå¯ç”¨Gradleæ„å»ºç¼“å­˜
          if [ "${{ inputs.incremental_build }}" = "true" ]; then
            echo "ä½¿ç”¨å¢é‡æ„å»ºæ¨¡å¼"
            ./gradlew :player:tv:assembleRelease --no-daemon --build-cache --offline || ./gradlew :player:tv:assembleRelease --no-daemon --build-cache
          else
            echo "ä½¿ç”¨å®Œæ•´æ„å»ºæ¨¡å¼"
            ./gradlew :player:tv:assembleRelease --no-daemon
          fi

      - name: Decode keystore.p12 and write signing.properties
        working-directory: ./fantasy-bv-source
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > keystore.p12
          cat <<EOF > signing.properties
          keystore.path=keystore.p12
          keystore.pwd=${{ secrets.KEYSTORE_PASSWORD }}
          keystore.alias=${{ secrets.KEY_ALIAS }}
          keystore.alias_pwd=${{ secrets.KEY_ALIAS_PASSWORD }}
          EOF

      # æ ¹æ®æ„å»ºæ¨¡å¼æ‰§è¡Œæ„å»º
      - name: Build APK based on mode
        id: build-apk
        working-directory: ./fantasy-bv-source
        run: |
          echo "=== å¼€å§‹æ„å»ºAPK ==="
          
          if [ "${{ inputs.incremental_build }}" = "true" ] && [ "${{ steps.check-source-changes.outputs.skip_build }}" = "true" ]; then
            echo "âœ… å¢é‡æ„å»ºæ¨¡å¼ï¼šæºä»£ç å†…å®¹æ— å˜åŒ–"
            echo "å°è¯•å¤ç”¨æœ€è¿‘çš„æˆåŠŸæ„å»º..."
            
            # æŸ¥æ‰¾æœ€è¿‘æ„å»ºçš„APK
            LATEST_APK=$(find . -name "fantasybv-*.apk" -type f -printf "%T@ %p\n" 2>/dev/null | sort -rn | head -1 | cut -d' ' -f2-)
            
            if [ -n "$LATEST_APK" ] && [ -f "$LATEST_APK" ]; then
              echo "ğŸ“¦ æ‰¾åˆ°æœ€è¿‘APK: $(basename "$LATEST_APK")"
              mkdir -p ./app/build/outputs/apk/default/release/
              cp "$LATEST_APK" "./app/build/outputs/apk/default/release/fantasybv-${{ env.BUILD_DATE }}.apk"
              echo "âœ… å·²å¤ç”¨ç°æœ‰APK"
              echo "build_type=reused" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ æœªæ‰¾åˆ°å¯ç”¨APKï¼Œæ‰§è¡Œå¿«é€Ÿæ„å»º..."
              # ä½¿ç”¨ç¼“å­˜ï¼Œå¿«é€Ÿæ„å»º
              ./gradlew :app:assembleRelease --no-daemon --build-cache --offline --rerun-tasks || \
              ./gradlew :app:assembleRelease --no-daemon --build-cache
              echo "build_type=fast" >> $GITHUB_OUTPUT
            fi
          else
            # å®Œæ•´æ„å»ºæˆ–å†…å®¹æœ‰å˜åŒ–
            if [ "${{ inputs.incremental_build }}" = "true" ]; then
              echo "ğŸ”„ å¢é‡æ„å»ºæ¨¡å¼ï¼šæºä»£ç å†…å®¹æœ‰å˜åŒ–"
              ./gradlew :app:assembleRelease --no-daemon --build-cache
              echo "build_type=incremental" >> $GITHUB_OUTPUT
            else
              echo "ğŸ”¨ å®Œæ•´æ„å»ºæ¨¡å¼"
              ./gradlew :app:assembleRelease --no-daemon --refresh-dependencies
              echo "build_type=full" >> $GITHUB_OUTPUT
            fi
          fi
          
          echo ""
          echo "=== æ„å»ºå®Œæˆ ==="
          
          # ç¡®ä¿APKæ–‡ä»¶å­˜åœ¨å¹¶é‡å‘½å
          if ls ./app/build/outputs/apk/default/release/*.apk 1>/dev/null 2>&1; then
            mv ./app/build/outputs/apk/default/release/*.apk "./app/build/outputs/apk/default/release/fantasybv-${{ env.BUILD_DATE }}.apk"
            echo "âœ… APK: fantasybv-${{ env.BUILD_DATE }}.apk"
            echo "apk_exists=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ é”™è¯¯ï¼šæœªç”ŸæˆAPKæ–‡ä»¶"
            exit 1
          fi

      # ä¿å­˜å“ˆå¸Œå’Œç¼“å­˜
      - name: Save content hash for next build
        if: ${{ inputs.incremental_build == 'true' && steps.build-apk.outputs.apk_exists == 'true' }}
        working-directory: ./fantasy-bv-source
        run: |
          echo "=== ä¿å­˜å†…å®¹å“ˆå¸Œä¾›ä¸‹æ¬¡æ„å»ºä½¿ç”¨ ==="
          
          mkdir -p .incremental
          
          if [ -f ".incremental/current_content_hash.txt" ]; then
            cp .incremental/current_content_hash.txt .incremental/previous_content_hash.txt
            echo "âœ… å†…å®¹å“ˆå¸Œå·²ä¿å­˜: $(cat .incremental/previous_content_hash.txt)"
            
            # ä¿å­˜æ„å»ºä¿¡æ¯
            echo "æ„å»ºæ—¶é—´: $(date)" > .incremental/build_info.txt
            echo "æ„å»ºæ—¥æœŸ: ${{ env.BUILD_DATE }}" >> .incremental/build_info.txt
            echo "æ„å»ºæ¨¡å¼: ${{ steps.build-apk.outputs.build_type }}" >> .incremental/build_info.txt
            echo "æäº¤å“ˆå¸Œ: ${{ github.sha }}" >> .incremental/build_info.txt
          fi

      # ä¿å­˜Gradleç¼“å­˜ï¼ˆä»…å¢é‡æ„å»ºæ¨¡å¼ï¼‰
      - name: Save Gradle cache
        if: ${{ inputs.incremental_build == 'true' && steps.build-apk.outputs.apk_exists == 'true' }}
        uses: actions/cache/save@main
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            fantasy-bv-source/.gradle
            fantasy-bv-source/.gradle-build-cache
          key: ${{ steps.gradle-cache.outputs.cache-primary-key }}

      # ä¿å­˜æºä»£ç å†…å®¹å“ˆå¸Œç¼“å­˜
      - name: Save source content hash cache
        if: ${{ inputs.incremental_build == 'true' && steps.build-apk.outputs.apk_exists == 'true' }}
        uses: actions/cache/save@main
        with:
          path: fantasy-bv-source/.incremental
          key: ${{ runner.os }}-source-hash-${{ github.ref_name }}-${{ steps.check-source-changes.outputs.current_content_hash }}

      - name: Erase keystore, encrypt package and create release
        uses: ./ci_source/.github/actions/erase_aes256pac_release/
        with:
          P12_KEYSTORE_PATH: "./fantasy-bv-source/keystore.p12 ./fantasy-bv-source/signing.properties"
          ZIP_AES256_PWD: ${{ secrets.ZIP_AES256_PWD }}
          BUILD_ARTIFACT_PATH: "./fantasy-bv-source/app/build/outputs/apk/default/release/fantasybv-${{ env.BUILD_DATE }}.apk"
          RELEASE_TAG_NAME: "${{ env.BUILD_DATE }}-fantasybv"
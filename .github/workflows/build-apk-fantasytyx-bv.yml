name: build-apk-fantasytyx-bv

on:
  workflow_dispatch:
  workflow_call:

env:
  JDK_VERSION: '21'
  ANDROID_COMPILE_SDK: '36'
  ANDROID_BUILD_TOOLS: '36.0.0'
  GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Clean runner environment
        run: |
          # 清理可能存在的全局缓存文件
          rm -rf ~/.gradle/caches/transforms-*
          rm -rf ~/.android/build-cache/
 
       # 检出ci仓库，以便在runner中调用sh脚本
      - name: Checkout ci source repo (self)
        uses: actions/checkout@main
        with:
          # 指定一个子目录放ci仓库，避免与源仓库混淆
          path: android-ci-source

      # 并行克隆两个仓库
      - name: Checkout source repo (fantasy-bv)
        uses: actions/checkout@main
        with:
          # repository: zxgv5/fantasy-bv
          repository: fantasytyx/bv
          ref: develop
          path: fantasy-bv-source
          fetch-depth: 0

      - name: Checkout pre-built libs repo (bv-libs)
        uses: actions/checkout@main
        with:
          repository: zxgv5/bv-libs
          token: ${{ secrets.BV_LIBS_ACCESS_TOKEN }}
          ref: main
          path: bv-libs-source

      # 环境变量初始化
      - name: Initialization values
        run: |
          echo "BUILD_DATE=$(TZ=UTC-8 date +"%y.%m.%d-%H.%M.%S")" >> $GITHUB_ENV

      - name: Customize scripts
        run: |
          chmod +x $GITHUB_WORKSPACE/android-ci-source/scripts/customize-bv-fantasy.sh
          $GITHUB_WORKSPACE/android-ci-source/scripts/customize-bv-fantasy.sh

      # 从Monorepo精确合并每个库（核心改进）
      - name: Merge libraries from monorepo structure
        run: |
          echo "=== 从 bv-libs Monorepo 复制各子库 ==="
          cd fantasy-bv-source
          
          # 确保主项目的 libs 目录存在
          mkdir -p libs
          
          # 定义需要复制的库及其在bv-libs中的路径（与你提供的URL对应）
          declare -A LIB_PATHS
          LIB_PATHS=(
            ["akDanmaku"]="akDanmaku"
            ["av1Decoder"]="av1Decoder"
            ["ffmpegDecoder"]="ffmpegDecoder"
            ["libVLC"]="libVLC"
            ["media3Container"]="media3Container"
          )
          
          for LIB_NAME in "${!LIB_PATHS[@]}"; do
            SRC_PATH="../bv-libs-source/${LIB_PATHS[$LIB_NAME]}"
            DEST_PATH="libs/$LIB_NAME"
            
            echo "处理库: $LIB_NAME"
            echo "  源路径: $SRC_PATH"
            
            if [ -d "$SRC_PATH" ]; then
              # 删除目标目录，确保干净复制
              rm -rf "$DEST_PATH"
              # 复制整个库目录（包含 .aar 和 .kts 等所有文件）
              cp -r "$SRC_PATH" "$DEST_PATH"
              echo "  已复制到: $DEST_PATH"
              # 显示复制后的关键文件
              if [ -f "$DEST_PATH"/*.aar ]; then
                echo "  包含AAR文件: $(ls "$DEST_PATH"/*.aar | head -1 | xargs basename)"
              fi
            else
              echo "  错误：源路径不存在！"
              echo "  当前bv-libs-source目录内容:"
              ls -la "../bv-libs-source/" || true
              exit 1
            fi
            echo ""
          done
          
          echo "=== 合并完成，最终 libs/ 目录结构 ==="
          ls -la libs/
 
      # 设置构建环境
      - name: Cache gradle
        uses: actions/cache@main
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            fantasy-bv-source/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('fantasy-bv-source/gradle/wrapper/gradle-wrapper.properties') }}
 
      - name: Set up jdk 21
        uses: actions/setup-java@main
        with:
          java-version: ${{ env.JDK_VERSION }}
          distribution: 'temurin'

      # 验证与准备构建
      - name: Validate final project structure
        working-directory: ./fantasy-bv-source
        run: |
          echo "=== 最终项目完整性验证 ==="
          echo ""
          # echo "1. 验证预编译库:"
          for lib_dir in libs/*; do
            if [ -d "$lib_dir" ]; then
              lib_name=$(basename "$lib_dir")
              aar_count=$(find "$lib_dir" -name "*.aar" -type f | wc -l)
              kts_count=$(find "$lib_dir" -name "*.kts" -type f | wc -l)
              echo "  $lib_name: $aar_count个AAR文件, $kts_count个KTS文件"
            fi
          done
          # 已在build-lib-akdanmaku工作流中构建并提交，此处不再验证，节约资源，减少时间
          # echo ""
          # echo "2. 验证源码模块:"
          # if [ -f "akdanmaku/build.gradle.kts" ] || [ -f "akdanmaku/build.gradle" ]; then
          #   echo "  akdanmaku - 找到构建文件"
          # else
          #   echo "  akdanmaku - 缺少构建文件！"
          #   exit 1
          # fi
 
      - name: Prepare gradle environment
        working-directory: ./fantasy-bv-source
        run: |
          chmod +x gradlew
          echo "Gradle 版本信息:"
          ./gradlew --version

      # ========== 新增步骤：编译 player.tv 模块 ==========
      - name: Build player.tv module
        working-directory: ./fantasy-bv-source
        run: |
          echo "=== 编译 player.tv 模块，验证 TV 依赖 ==="
          ./gradlew :player:tv:assembleRelease --refresh-dependencies --no-daemon

      - name: Decode and write release keystore
        working-directory: ./fantasy-bv-source
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > keystore.p12

      - name: Write signing.properties for release build
        working-directory: ./fantasy-bv-source
        run: |
          cat <<EOF > signing.properties
          keystore.path=keystore.p12
          keystore.pwd=${{ secrets.KEYSTORE_PASSWORD }}
          keystore.alias=${{ secrets.KEY_ALIAS }}
          keystore.alias_pwd=${{ secrets.KEY_ALIAS_PASSWORD }}
          EOF

      # 顺序构建（先编译akdanmaku，再构建主应用）
      # 已在build-lib-akdanmaku工作流中构建并提交，此处不再单独构建，节约资源，减少时间
      # - name: Build danmaku module (akdanmaku)
      #   working-directory: ./fantasy-bv-source
      #   run: |
      #     echo "=== 开始编译弹幕库 (akdanmaku) ==="
      #     ./gradlew :akdanmaku:assembleRelease --no-daemon --stacktrace
      #     echo "=== akdanmaku 编译完成 ==="
 
      - name: Build release apk files
        working-directory: ./fantasy-bv-source
        run: |
          echo "=== 开始构建主应用 (所有依赖已就位) ==="
          ./gradlew :app:assembleRelease --no-daemon --stacktrace
          
          echo ""
          echo "=== 构建完成！查找APK产物 ==="
          find . -name "*.apk" -type f | grep -i release | while read apk; do
            echo "  $(ls -lh "$apk")"
          done || echo "未找到APK文件，请检查构建日志。"
          
          mv ./app/build/outputs/apk/default/release/*.apk ./app/build/outputs/apk/default/release/fantasybv-${{ env.BUILD_DATE }}.apk
 
      - name: Remove keystore
        working-directory: ./fantasy-bv-source
        run: |
          rm -f "keystore.p12"
          echo "Keystore removed successfully."

      - name: Install 7zip
        run: sudo apt-get update && sudo apt-get install -y p7zip-full

      - name: Create aes256 encrypted archive with filename encryption
        working-directory: ./fantasy-bv-source/app/build/outputs/apk/default/release
        run: |
          7z a \
            -p"${{ secrets.ZIP_AES256_PWD }}" \
            -mhe=on \
            -t7z \
            -m0=lzma2 \
            -mx=5 \
            -mfb=64 \
            -md=32m \
            -ms=on \
            -mhc=on \
            -ma=2 \
            ./fantasybv-${{ env.BUILD_DATE }}.7z \
            ./fantasybv-${{ env.BUILD_DATE }}.apk

      - name: Create github release & upload apk
        uses: softprops/action-gh-release@master
        with:
          tag_name: ${{env.BUILD_DATE}}-fantasybv
          files: |
            ./fantasy-bv-source/app/build/outputs/apk/default/release/fantasybv-${{ env.BUILD_DATE }}.7z
          draft: false
          prerelease: false

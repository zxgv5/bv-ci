name: build-fantasytyx-bv-no0

on:
  workflow_dispatch:
jobs:
  build-release:
    name: Build Release Apk
    runs-on: macos-latest

    steps:
      - name: Checkout source code with submodules
        uses: actions/checkout@main
        with:
          repository: xqqv5/fantasy-bv
          ref: develop
          path: bv-source
          submodules: 'recursive'
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'

      # 修复：先进入 bv-source 目录
      - name: Setup working directory
        run: cd bv-source

      # 修复：确保 app 目录存在并写入 google-services.json
      - name: Write google-services.json
        env:
          DATA: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          mkdir -p bv-source/app
          echo "$DATA" > bv-source/app/google-services.json
          echo "Google services file created at:"
          ls -la bv-source/app/

      # 修复：为 gradlew 添加执行权限
      - name: Grant execute permission for gradlew
        run: chmod +x bv-source/gradlew

      # 修复：添加签名属性
      - name: Add signing properties
        env:
          SIGNING_PROPERTIES: ${{ secrets.SIGNING_PROPERTIES }}
        run: |
          echo "$SIGNING_PROPERTIES" > bv-source/encoded_signing_properties
          base64 -Dd -i bv-source/encoded_signing_properties > bv-source/signing.properties
          echo "Signing properties created:"
          ls -la bv-source/signing.properties

      # 修复：添加 jks 文件
      - name: Add jks file
        env:
          SIGN_KEY: ${{ secrets.SIGN_KEY }}
        run: |
          echo "$SIGN_KEY" > bv-source/encoded_key
          base64 -Dd -i bv-source/encoded_key > bv-source/key.jks
          echo "Key file created:"
          ls -la bv-source/key.jks

      # 修复：在 bv-source 目录中构建
      - name: Build apk
        run: |
          cd bv-source
          ./gradlew assembleDefaultRelease assembleDefaultDebug
          echo "Build completed. Listing APK files:"
          find app/build/outputs/apk -name "*.apk" -type f | xargs ls -la

      # 修复：读取元数据文件
      - name: Read release apk output metadata
        id: apk-meta-release
        uses: juliangruber/read-file-action@v1
        with:
          path: bv-source/app/build/outputs/apk/default/release/output-metadata.json

      - name: Read debug apk output metadata
        id: apk-meta-debug
        uses: juliangruber/read-file-action@v1
        with:
          path: bv-source/app/build/outputs/apk/default/debug/output-metadata.json

      # 修复：正确解析 JSON 数据
      - name: Parse apk infos
        id: apk-infos
        run: |
          RELEASE_CONTENT='${{ steps.apk-meta-release.outputs.content }}'
          DEBUG_CONTENT='${{ steps.apk-meta-debug.outputs.content }}'
          
          # 解析 release 版本信息
          RELEASE_VERSION_CODE=$(echo "$RELEASE_CONTENT" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data['elements'][0]['versionCode'])")
          RELEASE_VERSION_NAME=$(echo "$RELEASE_CONTENT" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data['elements'][0]['versionName'])")
          
          # 解析 debug 版本信息
          DEBUG_VERSION_CODE=$(echo "$DEBUG_CONTENT" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data['elements'][0]['versionCode'])")
          DEBUG_VERSION_NAME=$(echo "$DEBUG_CONTENT" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data['elements'][0]['versionName'])")
          
          echo "release_info_version_code=$RELEASE_VERSION_CODE" >> $GITHUB_ENV
          echo "release_info_version_name=$RELEASE_VERSION_NAME" >> $GITHUB_ENV
          echo "release_debug_info_version_code=$DEBUG_VERSION_CODE" >> $GITHUB_ENV
          echo "release_debug_info_version_name=$DEBUG_VERSION_NAME" >> $GITHUB_ENV
          
          echo "Release: v$RELEASE_VERSION_NAME ($RELEASE_VERSION_CODE)"
          echo "Debug: v$DEBUG_VERSION_NAME ($DEBUG_VERSION_CODE)"

      # 修复：获取变更日志
      - name: Get changelog
        id: changelog
        run: |
          cd bv-source
          {
            echo "changelog<<EOF"
            # 如果没有特定提交范围，则获取最近10个提交
            if [ -z "${{ github.event.before }}" ] || [ -z "${{ github.sha }}" ]; then
              echo "Recent changes:"
              git log --oneline -10 --pretty=format:"- %s (%h)"
            else
              git log --pretty=format:"- %s (%h)" ${{ github.event.before }}..${{ github.sha }}
            fi
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      # 修复：上传调试版 APK
      - name: Archive release debug build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Release debug build artifact
          path: bv-source/app/build/outputs/apk/default/debug/*.apk

      # 修复：上传 release mapping
      - name: Archive release build mappings
        uses: actions/upload-artifact@v4
        with:
          name: Release build mappings
          path: bv-source/app/build/outputs/mapping/defaultRelease/*

      # 修复：上传 release APK
      - name: Archive release build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Release build artifact
          path: bv-source/app/build/outputs/apk/default/release/*.apk

      # 修复：压缩 mapping 文件
      - name: Zip mapping
        run: |
          cd bv-source
          mkdir -p ../artifacts
          zip -rj ../artifacts/mapping.zip app/build/outputs/mapping/defaultRelease
          echo "Mapping zip created:"
          ls -la ../artifacts/

      # 修复：发布到 GitHub Release
      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            bv-source/app/build/outputs/apk/default/debug/*.apk
            bv-source/app/build/outputs/apk/default/release/*.apk
            artifacts/mapping.zip
          tag_name: v${{ env.release_info_version_name }}
          name: Release v${{ env.release_info_version_name }}
          prerelease: false
          body: |
            ### Release v${{ env.release_info_version_name }} (${{ env.release_info_version_code }})
            
            **Debug Version:** v${{ env.release_debug_info_version_name }} (${{ env.release_debug_info_version_code }})
            
            **Changes:**
            ${{ steps.changelog.outputs.changelog }}
          target_commitish: ${{ github.sha }}
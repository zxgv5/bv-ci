name: build-fantasytyx-bv-no0

on:
  workflow_dispatch:
 
env:
  JDK_VERSION: '21'
  ANDROID_COMPILE_SDK: '36'
  ANDROID_BUILD_TOOLS: '36.0.0'
  GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
  
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # é˜¶æ®µ 1: å¹¶è¡Œå…‹éš†ä¸¤ä¸ªä»“åº“
      - name: Checkout MAIN source repo (fantasy-bv)
        uses: actions/checkout@main
        with:
          repository: zxgv5/fantasy-bv
          ref: develop
          path: fantasy-bv-source
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
 
      - name: Checkout PRE-BUILT libs repo (bv-libs)
        uses: actions/checkout@main
        with:
          repository: zxgv5/bv-libs
          # å…³é”®ï¼šæ ¹æ®å®é™…åˆ†æ”¯ä¿®æ”¹ï¼Œå¯èƒ½æ˜¯ main, master æˆ–å…¶ä»–
          ref: main
          path: bv-libs-source
 
      # é˜¶æ®µ 2: ä»Monorepoç²¾ç¡®åˆå¹¶æ¯ä¸ªåº“ï¼ˆæ ¸å¿ƒæ”¹è¿›ï¼‰
      - name: Merge Libraries from Monorepo Structure
        run: |
          echo "=== ä» bv-libs Monorepo å¤åˆ¶å„å­åº“ ==="
          cd fantasy-bv-source
          
          # ç¡®ä¿ä¸»é¡¹ç›®çš„ libs ç›®å½•å­˜åœ¨
          mkdir -p libs
          
          # å®šä¹‰éœ€è¦å¤åˆ¶çš„åº“åŠå…¶åœ¨bv-libsä¸­çš„è·¯å¾„ï¼ˆä¸ä½ æä¾›çš„URLå¯¹åº”ï¼‰
          declare -A LIB_PATHS
          LIB_PATHS=(
            ["av1Decoder"]="av1Decoder"
            ["ffmpegDecoder"]="ffmpegDecoder"
            ["libVLC"]="libVLC"
            ["media3Container"]="media3Container"
          )
          
          for LIB_NAME in "${!LIB_PATHS[@]}"; do
            SRC_PATH="../bv-libs-source/${LIB_PATHS[$LIB_NAME]}"
            DEST_PATH="libs/$LIB_NAME"
            
            echo "å¤„ç†åº“: $LIB_NAME"
            echo "  æºè·¯å¾„: $SRC_PATH"
            
            if [ -d "$SRC_PATH" ]; then
              # åˆ é™¤ç›®æ ‡ç›®å½•ï¼Œç¡®ä¿å¹²å‡€å¤åˆ¶
              rm -rf "$DEST_PATH"
              # å¤åˆ¶æ•´ä¸ªåº“ç›®å½•ï¼ˆåŒ…å« .aar å’Œ .kts ç­‰æ‰€æœ‰æ–‡ä»¶ï¼‰
              cp -r "$SRC_PATH" "$DEST_PATH"
              echo "  âœ… å·²å¤åˆ¶åˆ°: $DEST_PATH"
              # æ˜¾ç¤ºå¤åˆ¶åçš„å…³é”®æ–‡ä»¶
              if [ -f "$DEST_PATH"/*.aar ]; then
                echo "  åŒ…å«AARæ–‡ä»¶: $(ls "$DEST_PATH"/*.aar | head -1 | xargs basename)"
              fi
            else
              echo "  âŒ é”™è¯¯ï¼šæºè·¯å¾„ä¸å­˜åœ¨ï¼"
              echo "  å½“å‰bv-libs-sourceç›®å½•å†…å®¹:"
              ls -la "../bv-libs-source/" || true
              exit 1
            fi
            echo ""
          done
          
          echo "=== åˆå¹¶å®Œæˆï¼Œæœ€ç»ˆ libs/ ç›®å½•ç»“æ„ ==="
          ls -la libs/
 
      # é˜¶æ®µ 3: è®¾ç½®æ„å»ºç¯å¢ƒ
      - name: Cache Gradle
        uses: actions/cache@main
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            fantasy-bv-source/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('fantasy-bv-source/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
 
      - name: Set up JDK
        uses: actions/setup-java@main
        with:
          java-version: ${{ env.JDK_VERSION }}
          distribution: 'temurin'
 
      - name: Setup Android SDK (Minimal)
        uses: android-actions/setup-android@main
        with:
          api-level: ${{ env.ANDROID_COMPILE_SDK }}
          build-tools: ${{ env.ANDROID_BUILD_TOOLS }}
          accept-android-sdk-licenses: true
      
      # é˜¶æ®µ 4: åº”ç”¨é¡¹ç›®ç‰¹å®šé…ç½®
      - name: Fix App Version Calculation
        working-directory: ./fantasy-bv-source
        run: |
          config_file="buildSrc/src/main/kotlin/AppConfiguration.kt"
          if [ -f "$config_file" ]; then
            echo "æ­£åœ¨ä¿®æ”¹ç‰ˆæœ¬å·è®¡ç®—è§„åˆ™ (git commitè®¡æ•° + 1)..."
            sed -i.bak 's/"git rev-list --count HEAD".exec().toInt() - 5/"git rev-list --count HEAD".exec().toInt() + 1/' "$config_file"
            echo "ä¿®æ”¹å versionCode å®šä¹‰:"
            grep -A2 -B2 "versionCode.*by lazy" "$config_file"
          else
            echo "è­¦å‘Š: æœªæ‰¾åˆ° $config_fileï¼Œè·³è¿‡ç‰ˆæœ¬ä¿®æ”¹ã€‚"
          fi
 
      # é˜¶æ®µ 5: éªŒè¯ä¸å‡†å¤‡æ„å»º
      - name: Validate Final Project Structure
        working-directory: ./fantasy-bv-source
        run: |
          echo "=== æœ€ç»ˆé¡¹ç›®å®Œæ•´æ€§éªŒè¯ ==="
          echo ""
          echo "1. éªŒè¯é¢„ç¼–è¯‘åº“:"
          for lib_dir in libs/*; do
            if [ -d "$lib_dir" ]; then
              lib_name=$(basename "$lib_dir")
              aar_count=$(find "$lib_dir" -name "*.aar" -type f | wc -l)
              kts_count=$(find "$lib_dir" -name "*.kts" -type f | wc -l)
              echo "  $lib_name: $aar_countä¸ªAARæ–‡ä»¶, $kts_countä¸ªKTSæ–‡ä»¶"
            fi
          done
          echo ""
          echo "2. éªŒè¯æºç æ¨¡å—:"
          if [ -f "akdanmaku/build.gradle.kts" ] || [ -f "akdanmaku/build.gradle" ]; then
            echo "  âœ… akdanmaku - æ‰¾åˆ°æ„å»ºæ–‡ä»¶"
          else
            echo "  âŒ akdanmaku - ç¼ºå°‘æ„å»ºæ–‡ä»¶ï¼"
            exit 1
          fi
 
      - name: Prepare Gradle Environment
        working-directory: ./fantasy-bv-source
        run: |
          chmod +x gradlew
          echo "Gradle ç‰ˆæœ¬ä¿¡æ¯:"
          ./gradlew --version
 
      # é˜¶æ®µ 6: é¡ºåºæ„å»ºï¼ˆå…ˆç¼–è¯‘akdanmakuï¼Œå†æ„å»ºä¸»åº”ç”¨ï¼‰
      - name: Build Danmaku Module (akdanmaku)
        working-directory: ./fantasy-bv-source
        run: |
          echo "=== å¼€å§‹ç¼–è¯‘å¼¹å¹•åº“ (akdanmaku) ==="
          ./gradlew :akdanmaku:assembleRelease --no-daemon --stacktrace
          echo "=== akdanmaku ç¼–è¯‘å®Œæˆ ==="
 
      - name: Build Main Application
        working-directory: ./fantasy-bv-source
        run: |
          echo "=== å¼€å§‹æ„å»ºä¸»åº”ç”¨ (æ‰€æœ‰ä¾èµ–å·²å°±ä½) ==="
          ./gradlew :app:assembleRelease --no-daemon --stacktrace
          
          echo ""
          echo "=== ğŸ‰ æ„å»ºå®Œæˆï¼æŸ¥æ‰¾APKäº§ç‰© ==="
          find . -name "*.apk" -type f | grep -i release | while read apk; do
            echo "  ğŸ“¦ $(ls -lh "$apk")"
          done || echo "æœªæ‰¾åˆ°APKæ–‡ä»¶ï¼Œè¯·æ£€æŸ¥æ„å»ºæ—¥å¿—ã€‚"
 
      # é˜¶æ®µ 7: æ”¶é›†ä¸ä¸Šä¼ ç»“æœ
      - name: Upload APK Artifacts
        if: success()
        uses: actions/upload-artifact@main
        with:
          name: release-apks
          path: |
            fantasy-bv-source/app/build/outputs/apk/**/*release*.apk
            fantasy-bv-source/akdanmaku/build/outputs/aar/**/*release*.aar
          if-no-files-found: error
          retention-days: 30
 
      - name: Upload Build Logs for Debugging
        if: always()
        uses: actions/upload-artifact@main
        with:
          name: build-reports-and-libs
          path: |
            fantasy-bv-source/**/build/reports/
            # ä¸Šä¼ å¤åˆ¶åçš„libsç›®å½•ç»“æ„ä»¥ä¾›éªŒè¯
            fantasy-bv-source/libs/
          retention-days: 7
 
      - name: Create GitHub Release & Upload APK
        uses: softprops/action-gh-release@master
        with:
          tag_name: latest-release
          # è¦é™„åŠ åˆ°æ­¤æ¬¡å‘å¸ƒçš„æ–‡ä»¶åˆ—è¡¨
          files: |
            fantasy-bv-source/app/build/outputs/apk/release/*.apk
          # è®¾ç½®ä¸º true åˆ™æ¯æ¬¡è¿è¡Œè¦†ç›–åŒåè‰ç¨¿ï¼Œé€‚ç”¨äºæŒç»­é›†æˆæµ‹è¯•ç‰ˆ
          draft: false
          # æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
          prerelease: false
          
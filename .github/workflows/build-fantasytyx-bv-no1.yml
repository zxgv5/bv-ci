name: build-fantasytyx-bv-no1

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop ]
  workflow_dispatch:  # 允许手动触发构建

env:
  JDK_VERSION: '17'  # 根据项目需求调整Java版本
  ANDROID_COMPILE_SDK: '36'  # 根据项目配置调整
  ANDROID_BUILD_TOOLS: '36.0.0'  # 根据项目配置调整
  ANDROID_SDK_TOOLS: '9477386'  # 最新版本号，可调整

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout source code
      uses: actions/checkout@main
      with:
        repository: xqqv5/fantasy-bv
        ref: develop
        path: bv-source  # 将代码克隆到指定目录

    - name: Set up JDK ${{ env.JDK_VERSION }}
      uses: actions/setup-java@main
      with:
        java-version: ${{ env.JDK_VERSION }}
        distribution: 'temurin'  # 或者 'zulu', 'corretto' 等

    - name: Setup Android SDK
      uses: android-actions/setup-android@main
      # 或者使用以下手动设置Android SDK的方式
      
    - name: Setup Android SDK (Manual)
      run: |
        # 下载并解压Android SDK命令行工具
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-${ANDROID_SDK_TOOLS}_latest.zip -O cmdline-tools.zip
        mkdir -p $HOME/android-sdk/cmdline-tools
        unzip -q cmdline-tools.zip -d $HOME/android-sdk/cmdline-tools
        mv $HOME/android-sdk/cmdline-tools/cmdline-tools $HOME/android-sdk/cmdline-tools/latest
        
        # 设置环境变量
        echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
        echo "$HOME/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$HOME/android-sdk/platform-tools" >> $GITHUB_PATH
        echo "$HOME/android-sdk/build-tools/$ANDROID_BUILD_TOOLS" >> $GITHUB_PATH
        
        # 接受SDK许可证
        yes | sdkmanager --licenses || true

    - name: Install required Android SDK components
      run: |
        sdkmanager "platforms;android-$ANDROID_COMPILE_SDK"
        sdkmanager "platform-tools"
        sdkmanager "build-tools;$ANDROID_BUILD_TOOLS"
        sdkmanager "cmdline-tools;latest"

    - name: Create keystore and signing properties
      run: |
        cd bv-source
        
        # 方法1：使用标准语法（推荐）
        keytool -genkeypair \
          -v \
          -keystore keystore.jks \
          -alias "${{ secrets.KEYSTORE_ALIAS }}" \
          -keyalg RSA \
          -keysize 4096 \
          -validity 10000 \
          -storepass "${{ secrets.KEYSTORE_PASSWORD }}" \
          -keypass "${{ secrets.KEY_PASSWORD }}" \
          -dname "CN=Android Developer, OU=Android, O=Company, L=City, ST=State, C=US" \
          -storetype JKS
        
        # 创建signing.properties文件
        cat > signing.properties << EOF
              keystore.path=./keystore.jks
              keystore.pwd=${{ secrets.KEYSTORE_PASSWORD }}
              keystore.alias=${{ secrets.KEYSTORE_ALIAS }}
              keystore.alias_pwd=${{ secrets.KEY_PASSWORD }}
              EOF
        
        echo "Created files:"
        ls -la keystore.jks signing.properties

    - name: DEBUG - Find source of versionCode -4
      run: |
        cd bv-source
        
        echo "=== 深入搜索versionCode -4的来源 ==="
        
        # 1. 搜索所有包含versionCode的文件
        echo "=== 搜索所有包含versionCode的文件 ==="
        find . -type f \( -name "*.kt" -o -name "*.kts" -o -name "*.gradle" -o -name "*.properties" -o -name "*.xml" \) \
          -not -path "./build/*" -not -path "./.gradle/*" -not -path "./.idea/*" \
          -exec grep -l "versionCode\|-4" {} \; 2>/dev/null | while read file; do
          echo "=== 文件: $file ==="
          grep -n "versionCode\|-4" "$file" 2>/dev/null || true
        done
        
        # 2. 特别搜索buildSrc目录
        echo "=== 搜索buildSrc目录 ==="
        find buildSrc -type f \( -name "*.kt" -o -name "*.kts" \) 2>/dev/null | while read file; do
          echo "=== buildSrc文件: $file ==="
          grep -n "versionCode\|AppConfiguration" "$file" 2>/dev/null || true
        done
        
        # 3. 搜索Companion对象中的版本号
        echo "=== 搜索可能包含-4的常量定义 ==="
        grep -r "\-4" . --include="*.kt" --include="*.kts" --include="*.java" 2>/dev/null | grep -v ".gradle" | head -20 || true

    - name: HARD FIX - 强制覆盖所有可能的versionCode
      run: |
        cd bv-source
        
        echo "=== 强制覆盖所有versionCode设置 ==="
        
        # 方法1: 修改所有gradle文件中的versionCode
        find . -name "*.gradle.kts" -o -name "*.gradle" | grep -v "/build/" | while read file; do
          echo "处理文件: $file"
          # 备份
          cp "$file" "${file}.bak" 2>/dev/null || true
          
          # 替换所有versionCode = 任意值 为 versionCode = 1001
          sed -i 's/versionCode\s*=\s*-?[0-9]\+/versionCode = 1001/g' "$file" 2>/dev/null || true
          sed -i 's/versionCode\s*=\s*AppConfiguration\.versionCode/versionCode = 1001/g' "$file" 2>/dev/null || true
          sed -i 's/versionCode\s*=\s*[a-zA-Z._]*versionCode/versionCode = 1001/g' "$file" 2>/dev/null || true
        done
        
        # 方法2: 修改所有Kotlin文件
        find . -name "*.kt" | grep -v "/build/" | while read file; do
          echo "检查Kotlin文件: $file"
          if grep -q "versionCode\|VersionCode" "$file"; then
            echo "在Kotlin文件中找到versionCode: $file"
            # 备份
            cp "$file" "${file}.bak" 2>/dev/null || true
            
            # 替换-4为1001
            sed -i 's/\-4/1001/g' "$file" 2>/dev/null || true
            
            # 替换versionCode定义
            sed -i 's/versionCode\s*=\s*-?[0-9]\+/versionCode = 1001/g' "$file" 2>/dev/null || true
          fi
        done
        
        echo "=== 显示修改结果 ==="
        grep -r "versionCode" . --include="*.kt" --include="*.kts" --include="*.gradle" 2>/dev/null | grep -v "/build/" | grep -v ".gradle/" | head -30 || true

    - name: Grant execute permission for gradlew
      run: |
        cd bv-source
        chmod +x gradlew

    - name: Build with Gradle
      run: |
        cd bv-source
        
        # 可选：查看当前目录结构
        ls -la
        
        # 执行构建
        ./gradlew clean assembleRelease
        
        # 检查生成的APK文件
        find . -name "*.apk" -type f

    - name: Upload APK artifact
      uses: actions/upload-artifact@main
      with:
        name: bv-app-release
        path: bv-source/app/build/outputs/apk/release/*.apk  # 根据实际项目结构调整路径
        retention-days: 7  # 保留7天

    - name: Upload build logs
      if: always()  # 即使构建失败也上传日志
      uses: actions/upload-artifact@main
      with:
        name: build-logs
        path: |
          bv-source/app/build/outputs/
          bv-source/build/reports/
        retention-days: 7
name: build-fantasytyx-bv-no3

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop ]
  workflow_dispatch:

env:
  JDK_VERSION: '17'
  ANDROID_COMPILE_SDK: '36'
  ANDROID_BUILD_TOOLS: '36.0.0'
  NDK_VERSION: '25.2.9519653'
  CMAKE_VERSION: '3.22.1'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # é˜¶æ®µ 1: å‡†å¤‡ä»£ç ä¸ç¯å¢ƒ
      - name: Checkout source code with ALL submodules
        uses: actions/checkout@v4
        with:
          repository: xqqv5/fantasy-bv
          ref: develop
          path: bv-source
          submodules: 'recursive'
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Cache Gradle to accelerate build
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            bv-source/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties', '**/*.gradle*', '**/gradle.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Set up JDK ${{ env.JDK_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JDK_VERSION }}
          distribution: 'temurin'

      - name: Install Android SDK, NDK and CMake (FIXED VERSION)
        uses: android-actions/setup-android@v3
        with:
          api-level: ${{ env.ANDROID_COMPILE_SDK }}
          build-tools: ${{ env.ANDROID_BUILD_TOOLS }}
          ndk: ${{ env.NDK_VERSION }} # å›ºå®šNDKç‰ˆæœ¬ï¼Œé¿å…å…¼å®¹æ€§é—®é¢˜
          cmake: ${{ env.CMAKE_VERSION }} # å›ºå®šCMakeç‰ˆæœ¬

      - name: Install essential native build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ninja-build \
            build-essential \
            nasm \
            yasm \
            pkg-config \
            autoconf \
            automake \
            libtool

      # é˜¶æ®µ 2: å¼ºåˆ¶åˆå§‹åŒ–ä¸éªŒè¯æ‰€æœ‰å­æ¨¡å—
      - name: Force initialize and update ALL submodules
        run: |
          cd bv-source
          echo "=== å¼ºåˆ¶é€’å½’åˆå§‹åŒ–å¹¶æ›´æ–°æ‰€æœ‰å­æ¨¡å— ==="
          # æ¸…é™¤å¯èƒ½çš„æ—§çŠ¶æ€ï¼Œç¡®ä¿æ‹‰å–æœ€æ–°
          git submodule deinit --force --all
          git submodule update --init --recursive --force --depth=1
          
          echo "=== éªŒè¯å…³é”®å­æ¨¡å—ç›®å½•æ˜¯å¦å­˜åœ¨ ==="
          # æ£€æŸ¥ä½ æåˆ°çš„æ‰€æœ‰å…³é”®åº“ç›®å½•
          for lib in libs/av1Decoder libs/ffmpegDecoder libs/libVLC libs/media3Container; do
            if [ -d "$lib" ]; then
              echo "âœ… $lib å­˜åœ¨"
              ls -la "$lib/" | head -5
            else
              echo "âŒ é”™è¯¯: $lib ä¸å­˜åœ¨ï¼"
              exit 1 # å…³é”®ç›®å½•ç¼ºå¤±ï¼Œç«‹å³å¤±è´¥
            fi
          done
          
          echo "=== éªŒè¯akdanmakuæ¨¡å— ==="
          if [ -d "akdanmaku" ]; then
            echo "âœ… akdanmaku å­˜åœ¨"
          else
            echo "âŒ é”™è¯¯: akdanmaku ä¸å­˜åœ¨ï¼"
            exit 1
          fi

      - name: Grant execute permission for gradlew
        run: |
          cd bv-source
          chmod +x gradlew
          ./gradlew --version # éªŒè¯Gradleç¯å¢ƒ

      # é˜¶æ®µ 3: æŒ‰é¡ºåºç‹¬ç«‹æ„å»ºæ¯ä¸€ä¸ªå‰ç½®åŸç”Ÿåº“ (å¤±è´¥åˆ™ç«‹å³åœæ­¢)
      - name: Build Core Native Library - av1Decoder
        run: |
          cd bv-source
          echo "=== å¼€å§‹æ„å»º av1Decoder (åŸºç¡€ä¾èµ–) ==="
          ./gradlew :libs:av1Decoder:assembleRelease --no-daemon --stacktrace --info
          # éªŒè¯äº§ç‰©æ˜¯å¦ç”Ÿæˆ
          if find libs/av1Decoder -name "*.so" -o -name "*.aar" | grep -q '.'; then
            echo "âœ… av1Decoder æ„å»ºæˆåŠŸï¼Œäº§ç‰©å·²ç”Ÿæˆã€‚"
          else
            echo "âŒ é”™è¯¯: av1Decoder æœªæ‰¾åˆ°è¾“å‡ºäº§ç‰©ï¼"
            exit 1
          fi

      - name: Build Core Native Library - ffmpegDecoder
        run: |
          cd bv-source
          echo "=== å¼€å§‹æ„å»º ffmpegDecoder (æ ¸å¿ƒè§£ç å™¨) ==="
          ./gradlew :libs:ffmpegDecoder:assembleRelease --no-daemon --stacktrace --info
          if find libs/ffmpegDecoder -name "*.so" -o -name "*.aar" | grep -q '.'; then
            echo "âœ… ffmpegDecoder æ„å»ºæˆåŠŸï¼Œäº§ç‰©å·²ç”Ÿæˆã€‚"
          else
            echo "âŒ é”™è¯¯: ffmpegDecoder æœªæ‰¾åˆ°è¾“å‡ºäº§ç‰©ï¼"
            exit 1
          fi

      - name: Build Core Native Library - libVLC
        run: |
          cd bv-source
          echo "=== å¼€å§‹æ„å»º libVLC ==="
          ./gradlew :libs:libVLC:assembleRelease --no-daemon --stacktrace --info
          if find libs/libVLC -name "*.so" -o -name "*.aar" | grep -q '.'; then
            echo "âœ… libVLC æ„å»ºæˆåŠŸï¼Œäº§ç‰©å·²ç”Ÿæˆã€‚"
          else
            echo "âŒ é”™è¯¯: libVLC æœªæ‰¾åˆ°è¾“å‡ºäº§ç‰©ï¼"
            exit 1
          fi

      - name: Build Core Native Library - media3Container
        run: |
          cd bv-source
          echo "=== å¼€å§‹æ„å»º media3Container ==="
          ./gradlew :libs:media3Container:assembleRelease --no-daemon --stacktrace --info
          if find libs/media3Container -name "*.so" -o -name "*.aar" | grep -q '.'; then
            echo "âœ… media3Container æ„å»ºæˆåŠŸï¼Œäº§ç‰©å·²ç”Ÿæˆã€‚"
          else
            echo "âŒ é”™è¯¯: media3Container æœªæ‰¾åˆ°è¾“å‡ºäº§ç‰©ï¼"
            exit 1
          fi

      # é˜¶æ®µ 4: æ„å»ºå¼¹å¹•åº“ (çº¯Kotlin/Javaï¼Œä¾èµ–åŸç”Ÿåº“)
      - name: Build Danmaku Library - akdanmaku
        run: |
          cd bv-source
          echo "=== å¼€å§‹æ„å»ºå¼¹å¹•åº“ akdanmaku ==="
          ./gradlew :akdanmaku:assembleRelease --no-daemon --stacktrace --info
          if find akdanmaku -name "*.aar" | grep -q '.'; then
            echo "âœ… akdanmaku æ„å»ºæˆåŠŸï¼Œäº§ç‰©å·²ç”Ÿæˆã€‚"
          else
            echo "âŒ é”™è¯¯: akdanmaku æœªæ‰¾åˆ°è¾“å‡ºäº§ç‰©ï¼"
            exit 1
          fi

      # é˜¶æ®µ 5: æ„å»ºä¸»åº”ç”¨ (æ­¤æ—¶æ‰€æœ‰ä¾èµ–å·²å°±ç»ª)
      - name: Build Main Application (Depends on all libraries)
        run: |
          cd bv-source
          echo "=== å¼€å§‹æ„å»ºä¸»åº”ç”¨ï¼Œæ‰€æœ‰å‰ç½®ä¾èµ–å·²å°±ç»ª ==="
          # æ­¤å‘½ä»¤ä¼šè‡ªåŠ¨è§£ææ‰€æœ‰ `project()` ä¾èµ–å¹¶æŒ‰éœ€ç¼–è¯‘
          ./gradlew :app:assembleRelease --no-daemon --stacktrace --info
          
          echo "=== æœ€ç»ˆAPKäº§ç‰©åˆ—è¡¨ ==="
          find . -path "*/outputs/apk/*release/*.apk" -type f | while read apk; do
            echo "ğŸ“ æ‰¾åˆ°: $apk"
            ls -lh "$apk"
          done

      # é˜¶æ®µ 6: æ”¶é›†ä¸ä¸Šä¼ äº§ç‰©
      - name: Upload APK Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: bv-release-apks
          path: |
            bv-source/**/outputs/apk/**/*.apk
            bv-source/**/outputs/aar/**/*.aar
          if-no-files-found: error
          retention-days: 30

      - name: Upload Build Logs (for debugging if any step fails)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            bv-source/**/build/reports/
            ${{ runner.temp }}/log_*.txt
          retention-days: 7
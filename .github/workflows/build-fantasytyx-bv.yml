name: build-fantasytyx-bv

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'è¦æ„å»ºçš„åˆ†æ”¯'
        required: false
        default: 'develop'
      tag:
        description: 'è¦æ„å»ºçš„æ ‡ç­¾ï¼ˆå¦‚æœæœ‰ï¼‰'
        required: false
        default: 'fantasy-latest'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup workspace
      run: |
        echo "å·¥ä½œæµå¼€å§‹æ—¶é—´: $(date)"
        echo "æ„å»ºä»“åº“: xqqv5/fantasy-bv"
        echo "æ„å»ºåˆ†æ”¯: ${{ github.event.inputs.branch || 'develop' }}"
        
    - name: Checkout source code from xqqv5/fantasy-bv
      uses: actions/checkout@main
      with:
        repository: xqqv5/fantasy-bv
        ref: ${{ github.event.inputs.branch || 'develop' }}
        token: ${{ secrets.REPO_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
        path: ./fantasy-bv
        fetch-depth: 0
        
    - name: Set up JDK 21 (Latest LTS)
      uses: actions/setup-java@main
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'gradle'
        
    - name: Setup Android SDK (ä¿®æ­£ç‰ˆ)
      run: |
        echo "è®¾ç½®Android SDKç¯å¢ƒ..."
        
        # è®¾ç½®Android SDKæ ¹ç›®å½•
        ANDROID_HOME="/usr/local/lib/android/sdk"
        echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
        
        # ç¡®ä¿ç›®å½•å­˜åœ¨
        sudo mkdir -p $ANDROID_HOME
        sudo chmod -R 777 $ANDROID_HOME
        
        # ä¸‹è½½å‘½ä»¤è¡Œå·¥å…·
        echo "ä¸‹è½½Androidå‘½ä»¤è¡Œå·¥å…·..."
        cd /tmp
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-10406996_latest.zip -O cmdline-tools.zip
        
        # è§£å‹åˆ°æ­£ç¡®ä½ç½®
        mkdir -p $ANDROID_HOME/cmdline-tools
        unzip -q cmdline-tools.zip -d $ANDROID_HOME/cmdline-tools
        mv $ANDROID_HOME/cmdline-tools/cmdline-tools $ANDROID_HOME/cmdline-tools/latest
        
        # æ¸…ç†
        rm -f cmdline-tools.zip
        
        # æ·»åŠ åˆ°PATH
        echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH
        echo "$ANDROID_HOME/emulator" >> $GITHUB_PATH
        
        echo "Android SDKå‘½ä»¤è¡Œå·¥å…·å®‰è£…å®Œæˆ"
        
    - name: Install Android packages
      run: |
        echo "å®‰è£…Android SDKç»„ä»¶..."
        
        # æ›´æ–°ç¯å¢ƒå˜é‡
        export ANDROID_HOME="/usr/local/lib/android/sdk"
        export ANDROID_SDK_ROOT="$ANDROID_HOME"
        
        # æ¥å—è®¸å¯è¯
        yes | sdkmanager --licenses
        
        # å®‰è£…å¿…è¦çš„ç»„ä»¶ï¼ˆé€ä¸ªå®‰è£…ï¼Œé¿å…æ ¼å¼é”™è¯¯ï¼‰
        echo "å®‰è£…platform-tools..."
        sdkmanager "platform-tools"
        
        echo "å®‰è£…platforms;android-34..."
        sdkmanager "platforms;android-34"
        
        echo "å®‰è£…build-tools;34.0.0..."
        sdkmanager "build-tools;34.0.0"
        
        echo "å®‰è£…å¿…è¦çš„é¢å¤–å·¥å…·..."
        sdkmanager "cmdline-tools;latest"
        sdkmanager "patcher;v4"
        
        # åˆ—å‡ºå·²å®‰è£…çš„åŒ…
        echo "å·²å®‰è£…çš„Android SDKåŒ…:"
        sdkmanager --list | grep -E "installed|platform|build-tools"
        
        echo "Android SDKç»„ä»¶å®‰è£…å®Œæˆ"
        
    - name: Configure Android environment
      run: |
        echo "é…ç½®Androidç¯å¢ƒ..."
        
        # åˆ›å»ºå¿…è¦çš„ç›®å½•å’Œæ–‡ä»¶
        mkdir -p ~/.android
        touch ~/.android/repositories.cfg
        
        # éªŒè¯Android SDKå®‰è£…
        echo "Android SDKç‰ˆæœ¬:"
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --version
        
        echo "Android SDKè·¯å¾„: $ANDROID_SDK_ROOT"
        echo "å¹³å°å·¥å…·ç‰ˆæœ¬:"
        $ANDROID_SDK_ROOT/platform-tools/adb version
        
        echo "ç¯å¢ƒé…ç½®å®Œæˆ"
        
    - name: Verify project structure
      run: |
        echo "é¡¹ç›®ç›®å½•ç»“æ„:"
        cd fantasy-bv && ls -la
        
        echo "æ£€æŸ¥GradleåŒ…è£…å™¨:"
        if [ -f fantasy-bv/gradlew ]; then
          echo "âœ… GradleåŒ…è£…å™¨å­˜åœ¨"
          ls -la fantasy-bv/gradlew*
        else
          echo "âŒ GradleåŒ…è£…å™¨ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "æ£€æŸ¥é¡¹ç›®é…ç½®:"
        if [ -f fantasy-bv/settings.gradle.kts ] || [ -f fantasy-bv/settings.gradle ]; then
          echo "âœ… Gradleè®¾ç½®æ–‡ä»¶å­˜åœ¨"
        else
          echo "âŒ Gradleè®¾ç½®æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
    - name: Make gradlew executable
      run: |
        chmod +x fantasy-bv/gradlew
        echo "GradleåŒ…è£…å™¨æƒé™è®¾ç½®å®Œæˆ"
        
    - name: Generate keystore file for signing
      env:
        KEY_ALIAS: ${{ secrets.KEY_ALIAS || 'fantasytyx_key' }}
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS_PASSWORD: ${{ secrets.KEY_ALIAS_PASSWORD || secrets.KEYSTORE_PASSWORD }}
      run: |
        echo "ç”Ÿæˆkeystoreæ–‡ä»¶..."
        
        # è¿›å…¥é¡¹ç›®ç›®å½•
        cd fantasy-bv
        
        # æ£€æŸ¥æ˜¯å¦å·²æœ‰keystoreæ–‡ä»¶
        if [ -f keystore.jks ]; then
          echo "âš ï¸  keystore.jkså·²å­˜åœ¨ï¼Œè·³è¿‡ç”Ÿæˆ"
        else
          echo "æ­£åœ¨ç”Ÿæˆæ–°çš„keystore.jksæ–‡ä»¶..."
          
          # å¦‚æœå¯†ç æœªè®¾ç½®ï¼Œç”Ÿæˆéšæœºå¯†ç 
          if [ -z "$KEYSTORE_PASSWORD" ]; then
            echo "æœªè®¾ç½®KEYSTORE_PASSWORD secretï¼Œä½¿ç”¨éšæœºå¯†ç "
            KEYSTORE_PASSWORD=$(openssl rand -base64 32)
            KEY_ALIAS_PASSWORD=$KEYSTORE_PASSWORD
          fi
          
          # ç”Ÿæˆkeystoreæ–‡ä»¶
          keytool -genkeypair \
            -v \
            -keystore keystore.jks \
            -alias "$KEY_ALIAS" \
            -keyalg RSA \
            -keysize 4096 \
            -validity 10000 \
            -storepass "$KEYSTORE_PASSWORD" \
            -keypass "$KEY_ALIAS_PASSWORD" \
            -dname "CN=Fantasytyx, OU=Android, O=Fantasytyx, L=Unknown, ST=Unknown, C=CN" \
            -noprompt
          
          echo "âœ… keystore.jksç”ŸæˆæˆåŠŸ"
          ls -la keystore.jks
        fi
        
    - name: Create signing.properties file
      env:
        KEY_ALIAS: ${{ secrets.KEY_ALIAS || 'fantasytyx_key' }}
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD || 'android' }}
        KEY_ALIAS_PASSWORD: ${{ secrets.KEY_ALIAS_PASSWORD || secrets.KEYSTORE_PASSWORD || 'android' }}
      run: |
        echo "åˆ›å»ºsigning.propertiesæ–‡ä»¶..."
        
        # è¿›å…¥é¡¹ç›®ç›®å½•
        cd fantasy-bv
        
        # åˆ›å»ºsigning.propertiesæ–‡ä»¶
        cat > signing.properties << EOF
        # è‡ªåŠ¨ç”Ÿæˆçš„ç­¾åé…ç½®
        # ç”Ÿæˆæ—¶é—´: $(date)
        keystore.path=./keystore.jks
        keystore.pwd=$KEYSTORE_PASSWORD
        keystore.alias=$KEY_ALIAS
        keystore.alias_pwd=$KEY_ALIAS_PASSWORD
        EOF
        
        echo "âœ… signing.propertiesåˆ›å»ºæˆåŠŸ"
        echo "æ–‡ä»¶å†…å®¹ï¼ˆå¯†ç å·²éšè—ï¼‰:"
        sed 's/=.*/=***/g' signing.properties
        
    - name: Cache Gradle dependencies
      uses: actions/cache@main
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          fantasy-bv/.gradle
        key: ${{ runner.os }}-gradle-${{ hashFiles('fantasy-bv/gradle/wrapper/gradle-wrapper.properties', 'fantasy-bv/build.gradle*', 'fantasy-bv/settings.gradle*', 'fantasy-bv/app/build.gradle*') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Build Release APK
      run: |
        echo "å¼€å§‹æ„å»ºRelease APK..."
        
        # è¿›å…¥é¡¹ç›®ç›®å½•
        cd fantasy-bv
        
        # è®¾ç½®Javaå†…å­˜é€‰é¡¹ï¼ˆå¯é€‰ï¼Œå¦‚æœéœ€è¦ï¼‰
        export GRADLE_OPTS="-Xmx4g -Xms1g -XX:MaxMetaspaceSize=1g"
        
        # æ¸…ç†å¹¶æ„å»º
        ./gradlew clean assembleRelease --no-daemon --stacktrace
        
        echo "âœ… æ„å»ºå®Œæˆ"
        
        # æ˜¾ç¤ºæ„å»ºç»“æœ
        echo "æ„å»ºè¾“å‡ºæ–‡ä»¶:"
        find . -name "*.apk" -type f | xargs ls -lh
        find . -name "*.aab" -type f | xargs ls -lh
        
    - name: Collect build artifacts
      run: |
        echo "æ”¶é›†æ„å»ºäº§ç‰©..."
        
        # åˆ›å»ºäº§ç‰©ç›®å½•
        mkdir -p artifacts
        
        # å¤åˆ¶APKæ–‡ä»¶
        if ls fantasy-bv/app/build/outputs/apk/release/*.apk 1> /dev/null 2>&1; then
          cp fantasy-bv/app/build/outputs/apk/release/*.apk artifacts/
          echo "APKæ–‡ä»¶å·²å¤åˆ¶åˆ°artifactsç›®å½•"
        else
          echo "æœªæ‰¾åˆ°APKæ–‡ä»¶ï¼Œå°è¯•åœ¨å…¶ä»–ä½ç½®æŸ¥æ‰¾..."
          find fantasy-bv -name "*.apk" -type f -exec cp {} artifacts/ \;
        fi
        
        # å¤åˆ¶AABæ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰
        if ls fantasy-bv/app/build/outputs/bundle/release/*.aab 1> /dev/null 2>&1; then
          cp fantasy-bv/app/build/outputs/bundle/release/*.aab artifacts/
          echo "AABæ–‡ä»¶å·²å¤åˆ¶åˆ°artifactsç›®å½•"
        fi
        
        # æ˜¾ç¤ºæ”¶é›†åˆ°çš„äº§ç‰©
        echo "æ”¶é›†åˆ°çš„æ„å»ºäº§ç‰©:"
        ls -la artifacts/
        
        # è®°å½•æ„å»ºä¿¡æ¯
        echo "æ„å»ºä¿¡æ¯:" > artifacts/build-info.txt
        echo "ä»“åº“: xqqv5/fantasy-bv" >> artifacts/build-info.txt
        echo "åˆ†æ”¯: ${{ github.event.inputs.branch || 'develop' }}" >> artifacts/build-info.txt
        echo "æ„å»ºæ—¶é—´: $(date)" >> artifacts/build-info.txt
        echo "å·¥ä½œæµè¿è¡ŒID: ${{ github.run_id }}" >> artifacts/build-info.txt
        echo "æäº¤å“ˆå¸Œ: $(cd fantasy-bv && git rev-parse HEAD)" >> artifacts/build-info.txt
        
    - name: Upload APK artifacts
      uses: actions/upload-artifact@main
      with:
        name: fantasytyx-bv-apk-${{ github.run_number }}-${{ github.run_attempt }}
        path: artifacts/*
        retention-days: 30
        if-no-files-found: error
        
    - name: Create GitHub Release (å¦‚æœæŒ‡å®šäº†æ ‡ç­¾)
      if: github.event.inputs.tag != ''
      uses: softprops/action-gh-release@master
      with:
        tag_name: ${{ github.event.inputs.tag }}
        name: Fantasytyx BV ${{ github.event.inputs.tag }}
        body: |
          è‡ªåŠ¨æ„å»ºç‰ˆæœ¬: ${{ github.event.inputs.tag }}
          æ„å»ºæ—¶é—´: $(date)
          æºä»“åº“: xqqv5/fantasy-bv
          åˆ†æ”¯: ${{ github.event.inputs.branch || 'develop' }}
          
          æ„å»ºåŒ…å«:
          - APKå®‰è£…åŒ…
          - æ„å»ºä¿¡æ¯
        draft: false
        prerelease: false
        files: artifacts/*
        
    - name: Notify build completion
      if: success()
      run: |
        echo "ğŸ‰ Fantasytyx BV æ„å»ºæˆåŠŸå®Œæˆ!"
        echo "æ„å»ºäº§ç‰©å·²ä¸Šä¼ åˆ°GitHub Artifacts"
        echo "å·¥ä½œæµè¿è¡ŒID: ${{ github.run_id }}"
        echo "æŸ¥çœ‹Artifacts: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
name: build-fantasytyx-bv

on:
  workflow_dispatch:
    inputs:
      branch:
        description: '要构建的分支'
        required: false
        default: 'develop'
      tag:
        description: '要构建的标签（如果有）'
        required: false
		default: 'fantasy-bv-latest'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup workspace
      run: |
        echo "工作流开始时间: $(date)"
        echo "构建仓库: xqqv5/fantasy-bv"
        echo "构建分支: ${{ github.event.inputs.branch || 'develop' }}"
        
    - name: Checkout source code from xqqv5/fantasy-bv
      uses: actions/checkout@main
      with:
        repository: xqqv5/fantasy-bv
        ref: ${{ github.event.inputs.branch || 'develop' }}
        token: ${{ secrets.REPO_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
        path: ./fantasy-bv
        fetch-depth: 0
        
    - name: Set up JDK 21 (Latest LTS)
      uses: actions/setup-java@main
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'gradle'
        
    - name: Setup Android SDK environment
      uses: android-actions/setup-android@main
      
    - name: Install specific Android SDK components
      run: |
        echo "安装Android SDK组件..."
        
        # 设置环境变量
        export ANDROID_HOME="/usr/local/lib/android/sdk"
        export ANDROID_SDK_ROOT="$ANDROID_HOME"
        
        # 清理可能存在的冲突目录
        rm -rf "$ANDROID_HOME/cmdline-tools/latest-2" 2>/dev/null || true
        
        # 接受所有许可证
        yes | sdkmanager --licenses
        
        # 更新sdkmanager自身
        sdkmanager --update
        
        # 安装平台工具
        echo "安装 platform-tools..."
        sdkmanager "platform-tools"
        
        # 安装Android 34平台
        echo "安装 platforms;android-34..."
        sdkmanager "platforms;android-34"
        
        # 安装构建工具
        echo "安装 build-tools;34.0.0..."
        sdkmanager "build-tools;34.0.0"
        
        # 安装命令行工具（如果需要）
        echo "安装 cmdline-tools;latest..."
        sdkmanager "cmdline-tools;latest"
        
        # 列出已安装的组件
        echo "已安装的Android SDK组件:"
        sdkmanager --list_installed
        
    - name: Configure Android environment
      run: |
        echo "配置Android环境..."
        
        # 确保环境变量正确设置
        echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
        
        # 创建必要的目录
        mkdir -p ~/.android
        touch ~/.android/repositories.cfg
        
        # 验证安装
        echo "Android SDK安装验证:"
        ls -la $ANDROID_SDK_ROOT/cmdline-tools/
        echo "平台工具:"
        $ANDROID_SDK_ROOT/platform-tools/adb version
        
    - name: Verify project structure
      run: |
        echo "项目目录结构:"
        cd fantasy-bv && ls -la
        
        echo "检查Gradle包装器:"
        if [ -f fantasy-bv/gradlew ]; then
          echo "✅ Gradle包装器存在"
          ls -la fantasy-bv/gradlew*
        else
          echo "❌ Gradle包装器不存在"
          exit 1
        fi
        
        echo "检查项目配置:"
        if [ -f fantasy-bv/settings.gradle.kts ] || [ -f fantasy-bv/settings.gradle ]; then
          echo "✅ Gradle设置文件存在"
        else
          echo "❌ Gradle设置文件不存在"
          exit 1
        fi
        
    - name: Make gradlew executable
      run: |
        chmod +x fantasy-bv/gradlew
        echo "Gradle包装器权限设置完成"
        
    - name: Generate keystore file for signing
      env:
        KEY_ALIAS: ${{ secrets.KEY_ALIAS || 'fantasytyx_key' }}
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS_PASSWORD: ${{ secrets.KEY_ALIAS_PASSWORD || secrets.KEYSTORE_PASSWORD }}
      run: |
        echo "生成keystore文件..."
        
        # 进入项目目录
        cd fantasy-bv
        
        # 检查是否已有keystore文件
        if [ -f keystore.jks ]; then
          echo "⚠️  keystore.jks已存在，跳过生成"
        else
          echo "正在生成新的keystore.jks文件..."
          
          # 如果密码未设置，生成随机密码
          if [ -z "$KEYSTORE_PASSWORD" ]; then
            echo "未设置KEYSTORE_PASSWORD secret，使用随机密码"
            KEYSTORE_PASSWORD=$(openssl rand -base64 32)
            KEY_ALIAS_PASSWORD=$KEYSTORE_PASSWORD
          fi
          
          # 生成keystore文件
          keytool -genkeypair \
            -v \
            -keystore keystore.jks \
            -alias "$KEY_ALIAS" \
            -keyalg RSA \
            -keysize 4096 \
            -validity 10000 \
            -storepass "$KEYSTORE_PASSWORD" \
            -keypass "$KEY_ALIAS_PASSWORD" \
            -dname "CN=Fantasytyx, OU=Android, O=Fantasytyx, L=Unknown, ST=Unknown, C=CN" \
            -noprompt
          
          echo "✅ keystore.jks生成成功"
          ls -la keystore.jks
        fi
        
    - name: Create signing.properties file
      env:
        KEY_ALIAS: ${{ secrets.KEY_ALIAS || 'fantasytyx_key' }}
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD || 'android' }}
        KEY_ALIAS_PASSWORD: ${{ secrets.KEY_ALIAS_PASSWORD || secrets.KEYSTORE_PASSWORD || 'android' }}
      run: |
        echo "创建signing.properties文件..."
        
        # 进入项目目录
        cd fantasy-bv
        
        # 创建signing.properties文件
        cat > signing.properties << EOF
        # 自动生成的签名配置
        # 生成时间: $(date)
        keystore.path=./keystore.jks
        keystore.pwd=$KEYSTORE_PASSWORD
        keystore.alias=$KEY_ALIAS
        keystore.alias_pwd=$KEY_ALIAS_PASSWORD
        EOF
        
        echo "✅ signing.properties创建成功"
        echo "文件内容（密码已隐藏）:"
        sed 's/=.*/=***/g' signing.properties
        
    - name: Cache Gradle dependencies
      uses: actions/cache@main
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          fantasy-bv/.gradle
        key: ${{ runner.os }}-gradle-${{ hashFiles('fantasy-bv/gradle/wrapper/gradle-wrapper.properties', 'fantasy-bv/build.gradle*', 'fantasy-bv/settings.gradle*', 'fantasy-bv/app/build.gradle*') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Build Release APK
      run: |
        echo "开始构建Release APK..."
        
        # 进入项目目录
        cd fantasy-bv
        
        # 设置Java内存选项（可选，如果需要）
        export GRADLE_OPTS="-Xmx4g -Xms1g -XX:MaxMetaspaceSize=1g"
        
        # 清理并构建
        ./gradlew clean assembleRelease --no-daemon --stacktrace
        
        echo "✅ 构建完成"
        
        # 显示构建结果
        echo "构建输出文件:"
        find . -name "*.apk" -type f | xargs ls -lh
        find . -name "*.aab" -type f | xargs ls -lh
        
    - name: Collect build artifacts
      run: |
        echo "收集构建产物..."
        
        # 创建产物目录
        mkdir -p artifacts
        
        # 复制APK文件
        if ls fantasy-bv/app/build/outputs/apk/release/*.apk 1> /dev/null 2>&1; then
          cp fantasy-bv/app/build/outputs/apk/release/*.apk artifacts/
          echo "APK文件已复制到artifacts目录"
        else
          echo "未找到APK文件，尝试在其他位置查找..."
          find fantasy-bv -name "*.apk" -type f -exec cp {} artifacts/ \;
        fi
        
        # 复制AAB文件（如果有）
        if ls fantasy-bv/app/build/outputs/bundle/release/*.aab 1> /dev/null 2>&1; then
          cp fantasy-bv/app/build/outputs/bundle/release/*.aab artifacts/
          echo "AAB文件已复制到artifacts目录"
        fi
        
        # 显示收集到的产物
        echo "收集到的构建产物:"
        ls -la artifacts/
        
        # 记录构建信息
        echo "构建信息:" > artifacts/build-info.txt
        echo "仓库: xqqv5/fantasy-bv" >> artifacts/build-info.txt
        echo "分支: ${{ github.event.inputs.branch || 'develop' }}" >> artifacts/build-info.txt
        echo "构建时间: $(date)" >> artifacts/build-info.txt
        echo "工作流运行ID: ${{ github.run_id }}" >> artifacts/build-info.txt
        echo "提交哈希: $(cd fantasy-bv && git rev-parse HEAD)" >> artifacts/build-info.txt
        
    - name: Upload APK artifacts
      uses: actions/upload-artifact@main
      with:
        name: fantasytyx-bv-apk-${{ github.run_number }}-${{ github.run_attempt }}
        path: artifacts/*
        retention-days: 30
        if-no-files-found: error
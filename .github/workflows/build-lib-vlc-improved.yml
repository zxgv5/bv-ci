name: build-lib-vlc-improved

on:
  workflow_dispatch:
  workflow_call:

env:
  SOURCE_REPO: 'https://github.com/videolan/vlc-android.git'
  SOURCE_BRANCH: 'master'
  BUILD_DIR: 'vlc-android-source'
  GRADLE_VERSION: '8.13'
  VLC_CORE_REPO: 'https://code.videolan.org/videolan/vlc.git'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Setup environment
        run: |
          echo "BUILD_DATE=$(TZ=UTC-8 date +"%y.%m.%d-%H.%M.%S")" >> $GITHUB_ENV
          
      - name: Checkout ci repo
        uses: actions/checkout@main

      - name: Clone vlc android source
        run: |
          rm -rf "${{ env.BUILD_DIR }}"
          git clone --depth 1 --branch "${{ env.SOURCE_BRANCH }}" \
            "${{ env.SOURCE_REPO }}" "${{ env.BUILD_DIR }}"

      - name: Setup java 17
        uses: actions/setup-java@main
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            automake autopoint cmake build-essential libtool \
            patch pkg-config ragel subversion unzip git \
            flex python3 python3-pip wget ninja-build meson nasm yasm \
            libssl-dev protobuf-compiler gettext

      - name: Setup ndk r27 for vlc
        run: |
          # 下载 NDK r27b
          wget -q https://dl.google.com/android/repository/android-ndk-r27b-linux.zip
          unzip -q android-ndk-r27b-linux.zip -d /opt/
          
          echo "NDK版本信息:"
          grep 'Pkg.Revision' /opt/android-ndk-r27b/source.properties
          
          echo "ANDROID_NDK=/opt/android-ndk-r27b" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=/opt/android-ndk-r27b" >> $GITHUB_ENV
          
      - name: Set git identity globally
        run: |
          git config --global user.email "ci@github-actions"
          git config --global user.name "GitHub Actions CI"
          echo "Git身份已设置"

      - name: Initialize and modify vlc android project
        run: |
          cd "${{ env.BUILD_DIR }}"
          
          echo "=== 初始化项目 ==="
          ls -la
          
          # 设置Git身份（确保在子进程中有效）
          git config user.email "ci@github-actions"
          git config user.name "GitHub Actions CI"
          
          # 设置环境变量
          export ANDROID_SDK="$ANDROID_SDK_ROOT"
          export ANDROID_NDK="${{ env.ANDROID_NDK }}"
          export ANDROID_NDK_ROOT="${{ env.ANDROID_NDK }}"
          
          # 创建local.properties
          echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
          echo "ndk.dir=$ANDROID_NDK" >> local.properties
          
          # 确保gradlew可执行
          if [ -f "gradlew" ]; then
            chmod +x gradlew
          fi

      - name: Manually setup latest vlc and modify some source file
        run: |
          cd "${{ env.BUILD_DIR }}"
          
          echo "=== 手动设置VLC源代码 ==="
          
          # 1. 创建libvlcjni目录结构
          echo "创建libvlcjni目录结构..."
          mkdir -p libvlcjni/buildsystem
          
          # 2. 手动克隆libvlcjni（避免脚本中的克隆）
          if [ ! -d "libvlcjni/.git" ]; then
            echo "克隆libvlcjni..."
            git clone https://code.videolan.org/videolan/libvlcjni.git libvlcjni-temp
            cp -r libvlcjni-temp/* libvlcjni/
            rm -rf libvlcjni-temp
          fi
          
          # 3. 克隆最新的VLC核心代码（不使用get-vlc.sh）
          echo "克隆最新VLC核心代码..."
          rm -rf libvlcjni/vlc
          git clone "${{ env.VLC_CORE_REPO }}" libvlcjni/vlc
          
          # 4. 切换到master分支并更新到最新
          cd libvlcjni/vlc
          git checkout master
          git pull origin master
          
          echo "当前VLC版本:"
          git log --oneline -1
          
          # 5. 应用自定义修改
          echo "应用自定义修改..."
          
          # 修改 /lib/core.c
          sed -i 's/&& (asprintf (\&str, "%s LibVLC\/"PACKAGE_VERSION, http) != -1))/&& (asprintf (\&str, "%s abc_media_editor", http) != -1))/' lib/core.c
          
          # 修改 /src/libvlc.c
          sed -i 's/"VLC media player (LibVLC "VERSION")"/"abc media editor"/' src/libvlc.c
          sed -i 's/"VLC\/"PACKAGE_VERSION" LibVLC\/"PACKAGE_VERSION/"abc\/abc_media_editor\/"/' src/libvlc.c
          
          # 修改 /modules/access/live555.cpp
          sed -i 's/"LibVLC\/" VERSION/"abc_media_editor"/' modules/access/live555.cpp
          
          # 验证修改
          echo "修改验证:"
          grep -n "abc_media_editor\|abc media editor" lib/core.c src/libvlc.c modules/access/live555.cpp | head -10
          
          cd ../..
          
          echo "✅ VLC源代码设置完成"

      - name: Build for arm64-v8a with bypass
        run: |
          cd "${{ env.BUILD_DIR }}"
          
          echo "=== 构建 arm64-v8a ==="
          
          # 设置Git身份（确保每个步骤都设置）
          git config --global user.email "ci@github-actions"
          git config --global user.name "GitHub Actions CI"
          
          # 设置环境变量
          export ANDROID_SDK="$ANDROID_SDK_ROOT"
          export ANDROID_NDK="${{ env.ANDROID_NDK }}"
          export ANDROID_NDK_ROOT="${{ env.ANDROID_NDK }}"
          
          # 创建local.properties
          echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
          echo "ndk.dir=$ANDROID_NDK" >> local.properties
          
          # 创建绕过VLC源码检查的标志文件
          touch libvlcjni/vlc/.vlc_source_checked
          
          # 修改compile.sh以完全绕过源码检查
          if [ -f "buildsystem/compile.sh" ]; then
            # 备份原脚本
            cp buildsystem/compile.sh buildsystem/compile.sh.backup
            
            # 修改脚本，在适当位置添加-b参数
            sed -i 's/get_vlc_args=""/get_vlc_args="-b"/' buildsystem/compile.sh
            
            echo "✅ compile.sh已修改，将始终使用-b参数"
          fi
          
          # 开始构建
          echo "开始构建..."
          chmod +x buildsystem/compile.sh
          
          # 使用修改后的脚本构建
          time ./buildsystem/compile.sh -l -a arm64 --release -t 2>&1 | tee build_arm64.log
          
          # 检查结果
          if ls libvlcjni/libvlc/build/outputs/aar/*.aar 1>/dev/null 2>&1; then
            AAR_FILE=$(ls libvlcjni/libvlc/build/outputs/aar/*.aar | head -1)
            cp "$AAR_FILE" "../libvlc-arm64.aar"
            echo "✅ arm64-v8a 构建成功"
          else
            echo "❌ arm64-v8a 构建失败"
            echo "最后100行日志:"
            tail -100 build_arm64.log
            exit 1
          fi

      - name: Build for armeabi-v7a
        run: |
          cd "${{ env.BUILD_DIR }}"
          
          echo "=== 构建 armeabi-v7a ==="
          
          # 设置Git身份
          git config --global user.email "ci@github-actions"
          git config --global user.name "GitHub Actions CI"
          
          # 设置环境变量
          export ANDROID_SDK="$ANDROID_SDK_ROOT"
          export ANDROID_NDK="${{ env.ANDROID_NDK }}"
          export ANDROID_NDK_ROOT="${{ env.ANDROID_NDK }}"
          
          # 清理之前的构建产物（保留源码）
          rm -rf libvlcjni/libvlc/build/outputs/aar/*.aar 2>/dev/null || true
          rm -rf libvlcjni/libvlc/jni/obj/local/armeabi-v7a 2>/dev/null || true
          
          # 确保local.properties存在
          echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
          echo "ndk.dir=$ANDROID_NDK" >> local.properties
          
          # 开始构建
          echo "开始构建..."
          
          # 使用与arm64相同的脚本（已修改）
          time ./buildsystem/compile.sh -l -a arm --release -t 2>&1 | tee build_armv7.log
          
          # 检查结果
          if ls libvlcjni/libvlc/build/outputs/aar/*.aar 1>/dev/null 2>&1; then
            AAR_FILE=$(ls libvlcjni/libvlc/build/outputs/aar/*.aar | head -1)
            cp "$AAR_FILE" "../libvlc-armv7.aar"
            echo "✅ armeabi-v7a 构建成功"
          else
            echo "❌ armeabi-v7a 构建失败"
            echo "最后100行日志:"
            tail -100 build_armv7.log
            exit 1
          fi

      - name: Merge aar files
        run: |
          cd "${{ env.BUILD_DIR }}"
          
          echo "=== 合并AAR文件 ==="
          
          # 收集AAR文件
          AAR_FILES=($(find . -name "libvlc-*.aar" -type f))
          if [ ${#AAR_FILES[@]} -eq 0 ]; then
            # 尝试在上级目录查找
            AAR_FILES=($(find .. -name "libvlc-*.aar" -type f))
          fi
          
          if [ ${#AAR_FILES[@]} -eq 0 ]; then
            echo "错误: 未找到AAR文件"
            echo "当前目录内容:"
            find . -name "*.aar" -type f
            exit 1
          fi
          
          echo "找到的AAR文件:"
          for aar in "${AAR_FILES[@]}"; do
            echo "  - $aar"
          done
          
          # 创建合并目录
          mkdir -p merged-aar
          
          # 使用第一个AAR作为基础
          BASE_AAR="${AAR_FILES[0]}"
          echo "使用 $BASE_AAR 作为基础"
          unzip -q "$BASE_AAR" -d merged-aar
          
          # 合并其他AAR的jni库
          for aar in "${AAR_FILES[@]:1}"; do
            echo "合并: $aar"
            TEMP_DIR=$(mktemp -d)
            unzip -q "$aar" -d "$TEMP_DIR"
            
            # 复制jni目录
            if [ -d "$TEMP_DIR/jni" ]; then
              echo "  添加jni架构库"
              mkdir -p merged-aar/jni
              cp -r "$TEMP_DIR/jni"/* merged-aar/jni/ 2>/dev/null || true
            fi
            
            rm -rf "$TEMP_DIR"
          done
          
          # 重新打包
          cd merged-aar
          zip -qr ../libvlc-release.aar .
          cd ..
          
          echo "✅ AAR合并完成"
          echo "生成的文件:"
          ls -la *.aar
          
          echo "libvlc-release.aar 架构信息:"
          if [ -d "merged-aar/jni" ]; then
            echo "包含架构:"
            ls merged-aar/jni/
          fi
          
          # 复制到工作空间根目录
          cp libvlc-release.aar ../
          for aar in "${AAR_FILES[@]}"; do
            cp "$aar" ../
          done

      - name: Create github release
        uses: softprops/action-gh-release@master
        with:
          tag_name: ${{env.BUILD_DATE}}-vlclib
          files: |
            libvlc-release.aar
            libvlc-arm64.aar
            libvlc-armv7.aar
          draft: false
          prerelease: false

      - name: Push vlc aar to bv-libs repository
        env:
          TARGET_REPO: "git@github.com:zxgv5/bv-libs.git"
        run: |
          # 设置 SSH 密钥和配置
          echo "Setting up SSH configuration..."
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # 写入私钥
          echo "${{ secrets.BV_LIBS_DEPLOY_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          
          # 配置 SSH 不验证主机
          echo "Host github.com" >> ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config
          echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config
          chmod 600 ~/.ssh/config
          
          # 测试 SSH 连接
          echo "Testing SSH connection to GitHub..."
          ssh -T git@github.com 2>&1 | grep -v "successfully authenticated" || true
          
          # 设置 Git 配置
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git config --global init.defaultBranch main
          
          # 克隆目标仓库
          cd "$GITHUB_WORKSPACE"
          echo "Cloning target repository: ${{ env.TARGET_REPO }}"
          git clone ${{ env.TARGET_REPO }} target-repo
          cd target-repo
          
          # 确保在 main 分支
          git checkout main
          
          # 复制新的 AAR 文件到目标位置
          SOURCE_AAR="$GITHUB_WORKSPACE/libvlc-release.aar"
          TARGET_DIR="libVLC"
          
          # 检查 AAR 文件是否存在
          if [ -f "$SOURCE_AAR" ]; then
            echo "✓ Found AAR file: $SOURCE_AAR"
            
            # 确保目标目录存在
            mkdir -p "$TARGET_DIR"
            
            # 复制新文件
            echo "Copying new AAR file..."
            cp -v "$SOURCE_AAR" "$TARGET_DIR/libvlc-release.aar"
            
            # 提交更改
            echo "Committing changes..."
            git add "$TARGET_DIR/libvlc-release.aar"
            
            # 检查是否有更改
            if git diff --cached --quiet; then
              echo "No changes to commit."
            else
              git commit -m "Update VLC AAR (multi-arch: arm64+v7a) - ${{ env.BUILD_DATE }} [CI]"
              echo "Pushing to remote repository..."
              git push origin main
              echo "✓ Successfully pushed multi-architecture VLC AAR to ${{ env.TARGET_REPO }}"
            fi
          else
            echo "✗ Error: AAR file not found at $SOURCE_AAR"
            exit 1
          fi
          
          # 清理 SSH 密钥
          rm -f ~/.ssh/id_ed25519
          rm -f ~/.ssh/config

      # 可选：缓存构建结果以加速后续构建
      # - name: Cache build artifacts
      #   uses: actions/cache@main
      #   with:
      #     path: |
      #       ~/.gradle/caches
      #       ~/.gradle/wrapper
      #       vlc-android/.gradle
      #       vlc-android/libvlcjni/vlc/contrib
      #     key: ${{ runner.os }}-vlc-build-${{ hashFiles('vlc-android/compile.sh', 'vlc-android/build.gradle') }}
      #     restore-keys: |
      #       ${{ runner.os }}-vlc-build-
name: build-lib-vlc-improved

on:
  workflow_dispatch:
  workflow_call:

env:
  SOURCE_REPO: 'https://github.com/videolan/vlc-android.git'
  SOURCE_BRANCH: 'master'
  BUILD_DIR: 'vlc-android-source'
  GRADLE_VERSION: '8.13'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout ci repo
        uses: actions/checkout@main

      - name: Setup build environment
        run: |
          echo "BUILD_DATE=$(TZ=UTC-8 date +"%y.%m.%d-%H.%M.%S")" >> $GITHUB_ENV
          
          # 设置NDK r27环境变量
          echo "ANDROID_NDK=/opt/android-ndk-r27b" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=/opt/android-ndk-r27b" >> $GITHUB_ENV

      - name: Clone vlc android source
        run: |
          rm -rf "${{ env.BUILD_DIR }}"
          git clone --depth 1 --branch "${{ env.SOURCE_BRANCH }}" \
            "${{ env.SOURCE_REPO }}" "${{ env.BUILD_DIR }}"

      - name: Setup java 17
        uses: actions/setup-java@main
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            automake autopoint cmake build-essential libtool \
            patch pkg-config ragel subversion unzip git \
            flex python3 python3-pip wget ninja-build meson nasm yasm \
            libssl-dev protobuf-compiler gettext

      - name: Setup ndk r27
        run: |
          # 下载并设置NDK r27（VLC要求版本）
          wget -q https://dl.google.com/android/repository/android-ndk-r27b-linux.zip
          unzip -q android-ndk-r27b-linux.zip -d /opt/
          
          echo "NDK r27已安装到: /opt/android-ndk-r27b"
          echo "验证版本:"
          grep 'Pkg.Revision' /opt/android-ndk-r27b/source.properties

      - name: Configure project
        run: |
          cd "${{ env.BUILD_DIR }}"
          
          # 设置环境变量
          export ANDROID_SDK="$ANDROID_SDK_ROOT"
          export ANDROID_NDK="${{ env.ANDROID_NDK }}"
          export ANDROID_NDK_ROOT="${{ env.ANDROID_NDK }}"
          
          echo "构建环境:"
          echo "  SDK: $ANDROID_SDK"
          echo "  NDK: $ANDROID_NDK"
          
          # 创建配置文件
          echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
          echo "ndk.dir=$ANDROID_NDK" >> local.properties
          
          # 初始化Gradle
          ./gradlew wrapper --gradle-version=${{ env.GRADLE_VERSION }} --quiet

      - name: Initialize and modify vlc source
        run: |
          cd "${{ env.BUILD_DIR }}"
          
          echo "初始化VLC源码..."
          
          # 获取VLC核心代码
          if [ -f "libvlcjni/buildsystem/get-vlc.sh" ]; then
            (cd libvlcjni && ./buildsystem/get-vlc.sh -b)
          else
            echo "使用备用方法获取VLC源码..."
            git clone https://code.videolan.org/videolan/vlc.git libvlcjni/vlc
          fi
          
          # 应用自定义修改
          echo "应用自定义修改..."
          VLC_SRC="libvlcjni/vlc"
          
          # 修改文件
          sed -i 's/&& (asprintf (\&str, "%s LibVLC\/"PACKAGE_VERSION, http) != -1))/&& (asprintf (\&str, "%s abc_media_editor", http) != -1))/' "$VLC_SRC/lib/core.c"
          sed -i 's/"VLC media player (LibVLC "VERSION")"/"abc media editor"/' "$VLC_SRC/src/libvlc.c"
          sed -i 's/"VLC\/"PACKAGE_VERSION" LibVLC\/"PACKAGE_VERSION/"abc\/abc_media_editor\/"/' "$VLC_SRC/src/libvlc.c"
          sed -i 's/"LibVLC\/" VERSION/"abc_media_editor"/' "$VLC_SRC/modules/access/live555.cpp"

      - name: Build all architectures
        run: |
          cd "${{ env.BUILD_DIR }}"
          
          export ANDROID_SDK="$ANDROID_SDK_ROOT"
          export ANDROID_NDK="${{ env.ANDROID_NDK }}"
          export ANDROID_NDK_ROOT="${{ env.ANDROID_NDK }}"
          
          # 构建函数
          build_arch() {
            local arch=$1
            local log_file="build_$arch.log"
            
            echo "=== 开始构建 $arch ==="
            
            # 清理
            rm -rf libvlcjni/libvlc/build/outputs/aar/*.aar 2>/dev/null || true
            
            # 构建
            if ! ./buildsystem/compile.sh -l -a $arch --release -t -b 2>&1 | tee "$log_file"; then
              echo "❌ $arch 构建失败"
              tail -100 "$log_file"
              return 1
            fi
            
            # 检查结果
            if ls libvlcjni/libvlc/build/outputs/aar/*.aar 1>/dev/null 2>&1; then
              local aar_file=$(ls libvlcjni/libvlc/build/outputs/aar/*.aar | head -1)
              cp "$aar_file" "../libvlc-$arch.aar"
              echo "✅ $arch 构建成功"
              return 0
            else
              echo "❌ $arch 构建失败：未生成AAR文件"
              return 1
            fi
          }
          
          # 构建所有架构
          build_arch "arm64" || exit 1
          build_arch "arm" || exit 1

      - name: Merge and package
        run: |
          cd "${{ env.BUILD_DIR }}"
          
          echo "合并AAR文件..."
          
          # 收集所有AAR
          aar_files=(../libvlc-*.aar)
          if [ ${#aar_files[@]} -eq 0 ]; then
            echo "错误：未找到AAR文件"
            exit 1
          fi
          
          echo "找到的AAR文件: ${aar_files[@]}"
          
          # 创建合并目录
          mkdir -p merged
          unzip -q "${aar_files[0]}" -d merged
          
          # 合并其他AAR的jni库
          for aar in "${aar_files[@]:1}"; do
            echo "合并: $(basename $aar)"
            temp_dir=$(mktemp -d)
            unzip -q "$aar" -d "$temp_dir"
            
            # 复制jni目录
            if [ -d "$temp_dir/jni" ]; then
              cp -r "$temp_dir/jni"/* merged/jni/ 2>/dev/null || true
            fi
            
            rm -rf "$temp_dir"
          done
          
          # 重新打包
          cd merged
          zip -qr ../libvlc-release.aar .
          
          # 重命名
          
          echo "✅ 合并完成"
          echo "最终产物: libvlc-release.aar"
          echo "包含架构:"
          ls -la jni/ 2>/dev/null | grep -v "^total"

      - name: Create release
        uses: softprops/action-gh-release@master
        with:
          tag_name: ${{env.BUILD_DATE}}-vlclib
          files: |
            libvlc-release.aar
            libvlc-arm64.aar
            libvlc-armv7.aar
          draft: false
          prerelease: false

      - name: Push vlc aar to bv-libs repository
        env:
          TARGET_REPO: "git@github.com:zxgv5/bv-libs.git"
        run: |
          # 设置 SSH 密钥和配置
          echo "Setting up SSH configuration..."
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # 写入私钥
          echo "${{ secrets.BV_LIBS_DEPLOY_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          
          # 配置 SSH 不验证主机
          echo "Host github.com" >> ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config
          echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config
          chmod 600 ~/.ssh/config
          
          # 测试 SSH 连接
          echo "Testing SSH connection to GitHub..."
          ssh -T git@github.com 2>&1 | grep -v "successfully authenticated" || true
          
          # 设置 Git 配置
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git config --global init.defaultBranch main
          
          # 克隆目标仓库
          cd "$GITHUB_WORKSPACE"
          echo "Cloning target repository: ${{ env.TARGET_REPO }}"
          git clone ${{ env.TARGET_REPO }} target-repo
          cd target-repo
          
          # 确保在 main 分支
          git checkout main
          
          # 复制新的 AAR 文件到目标位置
          SOURCE_AAR="$GITHUB_WORKSPACE/libvlc-release.aar"
          TARGET_DIR="libVLC"
          
          # 检查 AAR 文件是否存在
          if [ -f "$SOURCE_AAR" ]; then
            echo "✓ Found AAR file: $SOURCE_AAR"
            
            # 确保目标目录存在
            mkdir -p "$TARGET_DIR"
            
            # 复制新文件
            echo "Copying new AAR file..."
            cp -v "$SOURCE_AAR" "$TARGET_DIR/libvlc-release.aar"
            
            # 提交更改
            echo "Committing changes..."
            git add "$TARGET_DIR/libvlc-release.aar"
            
            # 检查是否有更改
            if git diff --cached --quiet; then
              echo "No changes to commit."
            else
              git commit -m "Update VLC AAR (multi-arch: arm64+v7a) - ${{ env.BUILD_DATE }} [CI]"
              echo "Pushing to remote repository..."
              git push origin main
              echo "✓ Successfully pushed multi-architecture VLC AAR to ${{ env.TARGET_REPO }}"
            fi
          else
            echo "✗ Error: AAR file not found at $SOURCE_AAR"
            exit 1
          fi
          
          # 清理 SSH 密钥
          rm -f ~/.ssh/id_ed25519
          rm -f ~/.ssh/config

      # 可选：缓存构建结果以加速后续构建
      # - name: Cache build artifacts
      #   uses: actions/cache@main
      #   with:
      #     path: |
      #       ~/.gradle/caches
      #       ~/.gradle/wrapper
      #       vlc-android/.gradle
      #       vlc-android/libvlcjni/vlc/contrib
      #     key: ${{ runner.os }}-vlc-build-${{ hashFiles('vlc-android/compile.sh', 'vlc-android/build.gradle') }}
      #     restore-keys: |
      #       ${{ runner.os }}-vlc-build-
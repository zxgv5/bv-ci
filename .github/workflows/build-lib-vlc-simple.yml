name: build-lib-vlc-simple

on:
  push:
    branches: [ libvlc-3.6.5 ]
  pull_request:
    branches: [ libvlc-3.6.5 ]
  workflow_dispatch:  # 允许手动触发

env:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_NDK_ROOT: /usr/local/lib/android/sdk/ndk/25.2.9519653
  GRADLE_VERSION: 8.13

jobs:
  Build-libvlc:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        abi: [arm64-v8a, armeabi-v7a]
    
    steps:
    - name: Checkout-code
      uses: actions/checkout@v4
      with:
        ref: libvlc-3.6.5
        submodules: recursive
    
    - name: Setup-java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '8'
    
    - name: Setup-android-sdk
      uses: android-actions/setup-android@v3
    
    - name: Install-build-dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          automake \
          ant \
          autopoint \
          cmake \
          build-essential \
          libtool-bin \
          patch \
          pkg-config \
          protobuf-compiler \
          ragel \
          subversion \
          unzip \
          git \
          flex \
          python3 \
          python3-pip \
          wget \
          ninja-build \
          meson \
          nasm \
          yasm \
          libssl-dev \
          gobject-introspection \
          libgirepository1.0-dev
    
    - name: Setup-gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: ${{ env.GRADLE_VERSION }}
    
    - name: Configure-local-properties
      run: |
        echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
        echo "android.ndkPath=$ANDROID_NDK_ROOT" >> local.properties
    
    - name: Create-gradle-properties
      run: |
        echo "android.enableJetifier=true" > gradle.properties
        echo "android.useAndroidX=true" >> gradle.properties
        echo "kapt.incremental.apt=true" >> gradle.properties
        echo "kapt.use.worker.api=true" >> gradle.properties
        echo "kapt.include.compile.classpath=false" >> gradle.properties
        echo "keyStoreFile=$HOME/.android/debug.keystore" >> gradle.properties
        echo "storealias=androiddebugkey" >> gradle.properties
        echo "storepwd=android" >> gradle.properties
    
    - name: Initialize-gradle-wrapper
      run: |
        chmod +x gradlew || true
        ./gradlew wrapper --gradle-version=$GRADLE_VERSION || echo "Gradle wrapper initialized"
    
    - name: Build-libvlc-for-${{ matrix.abi }}
      run: |
        export ANDROID_SDK="$ANDROID_SDK_ROOT"
        export ANDROID_NDK="$ANDROID_NDK_ROOT"
        export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH"
        
        # 设置架构参数
        if [ "${{ matrix.abi }}" = "arm64-v8a" ]; then
          ARCH="arm64"
          GRADLE_ABI="ARMv8"
        else
          ARCH="arm"
          GRADLE_ABI="ARMv7"
        fi
        
        echo "Building for ABI: ${{ matrix.abi }}, ARCH: $ARCH"
        
        # 构建libvlc
        chmod +x buildsystem/compile.sh
        ./buildsystem/compile.sh -l -a $ARCH --release
        
        # 查找生成的aar文件
        AAR_FILE=$(find . -name "*.aar" -type f | grep -i release | head -1)
        if [ -n "$AAR_FILE" ]; then
          echo "Found AAR: $AAR_FILE"
          mv "$AAR_FILE" "libvlc-${{ matrix.abi }}-release.aar"
        else
          # 如果没找到，尝试在libvlcjni目录中查找
          AAR_FILE=$(find libvlcjni -name "*.aar" -type f | grep -i release | head -1)
          if [ -n "$AAR_FILE" ]; then
            echo "Found AAR in libvlcjni: $AAR_FILE"
            mv "$AAR_FILE" "libvlc-${{ matrix.abi }}-release.aar"
          fi
        fi
    
    - name: Upload-build-artifacts
      uses: actions/upload-artifact@v4
      with:
        name: libvlc-${{ matrix.abi }}-release
        path: |
          libvlc-*.aar
          .dbg/${{ matrix.abi }}/*.so
        retention-days: 7
  
  Merge-and-release:
    needs: Build-libvlc
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/libvlc-3.6.5'
    
    steps:
    - name: Download-all-artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        pattern: libvlc-*-release
        merge-multiple: true
    
    - name: Merge-multi-abi-aar
      run: |
        echo "Merging multi-ABI AAR files..."
        
        # 创建临时目录
        mkdir -p merged-aar
        
        # 解压第一个aar作为基础
        FIRST_AAR=$(find artifacts -name "*.aar" | head -1)
        if [ -z "$FIRST_AAR" ]; then
          echo "No AAR files found!"
          exit 1
        fi
        
        echo "Using $FIRST_AAR as base"
        unzip -q "$FIRST_AAR" -d merged-aar
        
        # 合并其他ABI的so文件
        for AAR in artifacts/*.aar; do
          if [ "$AAR" != "$FIRST_AAR" ]; then
            echo "Merging $AAR"
            # 创建临时目录解压
            mkdir -p temp-aar
            unzip -q "$AAR" -d temp-aar
            
            # 复制jni目录（如果存在）
            if [ -d "temp-aar/jni" ]; then
              cp -r temp-aar/jni/* merged-aar/jni/ 2>/dev/null || true
            fi
            
            # 清理临时目录
            rm -rf temp-aar
          fi
        done
        
        # 重新打包为aar
        cd merged-aar
        zip -qr ../libvlc-release.aar .
        cd ..
        
        # 显示文件信息
        echo "Generated merged AAR:"
        ls -lh libvlc-release.aar
        
        # 验证内容
        echo "Contents of merged AAR:"
        unzip -l libvlc-release.aar | grep -E "(\.so$|AndroidManifest\.xml|classes\.jar)" | head -20
    
    - name: Create-release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          libvlc-release.aar
        tag_name: libvlc-v3.6.5-$(date +'%Y%m%d-%H%M%S')
        name: LibVLC 3.6.5 Build
        body: |
          Multi-ABI LibVLC release build
          
          Contains:
          - ARM64 (arm64-v8a)
          - ARMv7 (armeabi-v7a)
          
          Built from branch: ${{ github.ref }}
          Commit: ${{ github.sha }}
        draft: false
        prerelease: false
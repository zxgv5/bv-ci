name: build-lib-vlc-simple

on:
  workflow_dispatch:  # 只支持手动触发，因为CI不在源仓库中
    inputs:
      source_branch:
        description: 'Source repository branch to build'
        required: true
        default: 'libvlc-3.6.5'
        type: string
      tag_name:
        description: 'Tag name for the release'
        required: true
        default: 'libvlc-v3.6.5'
        type: string

env:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_NDK_ROOT: /usr/local/lib/android/sdk/ndk/25.2.9519653
  GRADLE_VERSION: 8.13
  SOURCE_REPO: https://github.com/videolan/vlc-android.git

jobs:
  Build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout ci repository
      uses: actions/checkout@v4
    
    - name: Clone source repository
      run: |
        echo "Cloning source repository: ${{ env.SOURCE_REPO }}"
        echo "Branch: ${{ github.event.inputs.source_branch }}"
        
        git clone --depth 1 --branch "${{ github.event.inputs.source_branch }}" \
          "${{ env.SOURCE_REPO }}" vlc-android-source
        
        echo "Source repository cloned successfully"
        echo "Source directory size:"
        du -sh vlc-android-source/
    
    - name: Setup java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '8'
    
    - name: Setup android sdk
      uses: android-actions/setup-android@v3
    
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          automake \
          ant \
          autopoint \
          cmake \
          build-essential \
          libtool-bin \
          patch \
          pkg-config \
          protobuf-compiler \
          ragel \
          subversion \
          unzip \
          git \
          flex \
          python3 \
          python3-pip \
          wget \
          ninja-build \
          meson \
          nasm \
          yasm \
          libssl-dev \
          gobject-introspection \
          libgirepository1.0-dev
    
    - name: Setup gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: ${{ env.GRADLE_VERSION }}
    
    - name: Configure build environment
      run: |
        cd vlc-android-source
        
        # 创建local.properties文件
        echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
        echo "android.ndkPath=$ANDROID_NDK_ROOT" >> local.properties
        
        # 创建gradle.properties文件
        echo "android.enableJetifier=true" > gradle.properties
        echo "android.useAndroidX=true" >> gradle.properties
        echo "kapt.incremental.apt=true" >> gradle.properties
        echo "kapt.use.worker.api=true" >> gradle.properties
        echo "kapt.include.compile.classpath=false" >> gradle.properties
        echo "keyStoreFile=$HOME/.android/debug.keystore" >> gradle.properties
        echo "storealias=androiddebugkey" >> gradle.properties
        echo "storepwd=android" >> gradle.properties
        
        # 初始化gradle wrapper
        chmod +x gradlew 2>/dev/null || true
        ./gradlew wrapper --gradle-version=$GRADLE_VERSION || echo "Gradle wrapper initialized"
        
        echo "Build environment configured"
    
    - name: Build libvlc for arm64
      run: |
        cd vlc-android-source
        
        export ANDROID_SDK="$ANDROID_SDK_ROOT"
        export ANDROID_NDK="$ANDROID_NDK_ROOT"
        export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH"
        
        echo "Building for ABI: arm64-v8a, ARCH: arm64 with release configuration"
        
        # 构建libvlc，使用release模式
        chmod +x buildsystem/compile.sh
        ./buildsystem/compile.sh -l -a arm64 --release
        
        # 查找生成的aar文件
        echo "Looking for release AAR files..."
        
        # 在libvlc模块的输出目录中查找
        if [ -d "libvlcjni/libvlc/build/outputs/aar" ]; then
          echo "Checking libvlcjni/libvlc/build/outputs/aar directory..."
          find libvlcjni/libvlc/build/outputs/aar -name "*.aar" -type f
          
          # 查找release版本
          AAR_FILE=$(find libvlcjni/libvlc/build/outputs/aar -name "*release*.aar" -type f | head -1)
          if [ -z "$AAR_FILE" ]; then
            AAR_FILE=$(find libvlcjni/libvlc/build/outputs/aar -name "*.aar" -type f | head -1)
          fi
        else
          echo "Searching in whole project..."
          AAR_FILE=$(find . -name "*.aar" -type f | head -1)
        fi
        
        if [ -n "$AAR_FILE" ]; then
          echo "Found AAR: $AAR_FILE"
          cp "$AAR_FILE" ../libvlc-arm64-release.aar
          echo "Copied AAR to workspace root"
        else
          echo "ERROR: No AAR file found for arm64 build!"
          exit 1
        fi
        
        # 复制构建的so文件（可选）
        mkdir -p ../build-output/arm64
        find . -name "*.so" -type f -path "*/arm64*" -exec cp {} ../build-output/arm64/ \; 2>/dev/null || true
    
    - name: Build libvlc for arm
      run: |
        cd vlc-android-source
        
        export ANDROID_SDK="$ANDROID_SDK_ROOT"
        export ANDROID_NDK="$ANDROID_NDK_ROOT"
        export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH"
        
        echo "Building for ABI: armeabi-v7a, ARCH: arm with release configuration"
        
        # 清理之前的构建，确保重新构建
        rm -rf libvlcjni/libvlc/build/outputs/aar/*.aar 2>/dev/null || true
        
        # 构建libvlc，使用release模式
        chmod +x buildsystem/compile.sh
        ./buildsystem/compile.sh -l -a arm --release
        
        # 查找生成的aar文件
        echo "Looking for release AAR files..."
        
        # 在libvlc模块的输出目录中查找
        if [ -d "libvlcjni/libvlc/build/outputs/aar" ]; then
          echo "Checking libvlcjni/libvlc/build/outputs/aar directory..."
          find libvlcjni/libvlc/build/outputs/aar -name "*.aar" -type f
          
          # 查找release版本
          AAR_FILE=$(find libvlcjni/libvlc/build/outputs/aar -name "*release*.aar" -type f | head -1)
          if [ -z "$AAR_FILE" ]; then
            AAR_FILE=$(find libvlcjni/libvlc/build/outputs/aar -name "*.aar" -type f | head -1)
          fi
        else
          echo "Searching in whole project..."
          AAR_FILE=$(find . -name "*.aar" -type f | head -1)
        fi
        
        if [ -n "$AAR_FILE" ]; then
          echo "Found AAR: $AAR_FILE"
          cp "$AAR_FILE" ../libvlc-arm-release.aar
          echo "Copied AAR to workspace root"
        else
          echo "ERROR: No AAR file found for arm build!"
          exit 1
        fi
        
        # 复制构建的so文件（可选）
        mkdir -p ../build-output/arm
        find . -name "*.so" -type f -path "*/armeabi-v7a*" -exec cp {} ../build-output/arm/ \; 2>/dev/null || true
    
    - name: Merge multi abi aar
      run: |
        echo "Merging multi-ABI AAR files..."
        
        # 检查是否有至少一个aar文件
        if [ ! -f "libvlc-arm64-release.aar" ] && [ ! -f "libvlc-arm-release.aar" ]; then
          echo "ERROR: No AAR files found to merge!"
          exit 1
        fi
        
        # 创建临时目录
        mkdir -p merged-aar/jni
        
        # 使用第一个可用的aar作为基础
        if [ -f "libvlc-arm64-release.aar" ]; then
          BASE_AAR="libvlc-arm64-release.aar"
        else
          BASE_AAR="libvlc-arm-release.aar"
        fi
        
        echo "Using $BASE_AAR as base"
        unzip -q "$BASE_AAR" -d merged-aar
        
        # 合并其他ABI的so文件
        if [ -f "libvlc-arm-release.aar" ] && [ "$BASE_AAR" != "libvlc-arm-release.aar" ]; then
          echo "Merging libvlc-arm-release.aar"
          mkdir -p temp-aar
          unzip -q "libvlc-arm-release.aar" -d temp-aar
          
          # 复制jni目录（如果存在）
          if [ -d "temp-aar/jni" ]; then
            cp -r temp-aar/jni/* merged-aar/jni/ 2>/dev/null || true
          fi
          
          rm -rf temp-aar
        fi
        
        if [ -f "libvlc-arm64-release.aar" ] && [ "$BASE_AAR" != "libvlc-arm64-release.aar" ]; then
          echo "Merging libvlc-arm64-release.aar"
          mkdir -p temp-aar
          unzip -q "libvlc-arm64-release.aar" -d temp-aar
          
          # 复制jni目录（如果存在）
          if [ -d "temp-aar/jni" ]; then
            cp -r temp-aar/jni/* merged-aar/jni/ 2>/dev/null || true
          fi
          
          rm -rf temp-aar
        fi
        
        # 重新打包为aar
        cd merged-aar
        zip -qr ../libvlc-release.aar .
        cd ..
        
        # 显示文件信息
        echo "Generated merged AAR: libvlc-release.aar"
        ls -lh libvlc-release.aar
        
        # 验证内容
        echo "Checking AAR contents:"
        unzip -l libvlc-release.aar | grep "\.so$" || echo "No .so files found"
        
        # 验证架构
        echo "Verifying architectures in AAR:"
        if unzip -l libvlc-release.aar | grep -q "arm64-v8a"; then
          echo "✓ ARM64 (arm64-v8a) architecture found"
        else
          echo "✗ ARM64 architecture not found"
        fi
        
        if unzip -l libvlc-release.aar | grep -q "armeabi-v7a"; then
          echo "✓ ARMv7 (armeabi-v7a) architecture found"
        else
          echo "✗ ARMv7 architecture not found"
        fi
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: libvlc-release-build
        path: |
          libvlc-release.aar
          libvlc-*-release.aar
          build-output/
        retention-days: 30
    
    - name: Create release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          libvlc-release.aar
        tag_name: ${{ github.event.inputs.tag_name }}-$(date +'%Y%m%d-%H%M%S')
        name: LibVLC Release Build - ${{ github.event.inputs.source_branch }}
        body: |
          # LibVLC Release Build
          
          This release contains a merged AAR file with both ARM architectures:
          - ARM64 (arm64-v8a)
          - ARMv7 (armeabi-v7a)
          
          ## Build Information
          - Source Repository: ${{ env.SOURCE_REPO }}
          - Source Branch: ${{ github.event.inputs.source_branch }}
          - Build Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - CI Run ID: ${{ github.run_id }}
          
          ## Usage
          
          Add this to your app's `build.gradle`:
          
          ```gradle
          dependencies {
              implementation files('libvlc-release.aar')
          }
          ```
          
          Or if you're using a local Maven repository:
          
          ```gradle
          repositories {
              flatDir {
                  dirs 'libs'
              }
          }
          
          dependencies {
              implementation name: 'libvlc-release', ext: 'aar'
          }
          ```
          
          ## AAR Contents
          
          This AAR contains the following JNI libraries for both architectures:
          - libvlc.so (VLC core library)
          - libvlcjni.so (JNI bindings)
          - Other required VLC dependencies
          
          ## License
          
          This build is licensed under the LGPLv2.1 license.
          
          ## Source
          
          Built from the official VLC Android repository:
          - Repository: ${{ env.SOURCE_REPO }}
          - Branch: ${{ github.event.inputs.source_branch }}
        draft: false
        prerelease: false
name: build-lib-vlc-simple

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
    inputs:
      source_branch:
        description: 'Branch of vlc-android repo to build from'
        required: true
        default: 'libvlc-3.6.5'
        type: string
      release_tag:
        description: 'Tag name for the GitHub Release'
        required: true
        default: 'libvlc-build'
        type: string

env:
  # å…³é”®ç¯å¢ƒå˜é‡
  SOURCE_REPO: 'https://github.com/videolan/vlc-android.git'
  BUILD_DIR: 'vlc-android-source'  # æºä»£ç å…‹éš†ç›®å½•
  GRADLE_VERSION: '8.13'           # ä¸é¡¹ç›®ä¸­çš„AGP 8.11.1å…¼å®¹

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤ 1: æ£€å‡º CI ä»“åº“è‡ªèº«ï¼ˆå¯é€‰ï¼Œç”¨äºå­˜æ”¾è„šæœ¬ï¼‰
      - name: Checkout CI repository
        uses: actions/checkout@v4

      # æ­¥éª¤ 2: å…‹éš† VLC å®‰å“æºä»£ç ä»“åº“
      - name: Clone source repository
        run: |
          echo "ğŸ“¥ Cloning source repo: ${{ env.SOURCE_REPO }}"
          echo "ğŸ“‚ Target branch: ${{ github.event.inputs.source_branch }}"
          # æ·±åº¦å…‹éš†æŒ‡å®šåˆ†æ”¯ä»¥èŠ‚çœæ—¶é—´å’Œç©ºé—´
          git clone --depth 1 --branch "${{ github.event.inputs.source_branch }}" \
            "${{ env.SOURCE_REPO }}" "${{ env.BUILD_DIR }}"
          echo "âœ… Source code cloned."

      # æ­¥éª¤ 3: è®¾ç½®ç»Ÿä¸€çš„ Java ç¯å¢ƒ (ä½¿ç”¨ Java 17)
      - name: Setup java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      # æ­¥éª¤ 4: å®‰è£…ç³»ç»Ÿæ„å»ºä¾èµ–
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            automake autopoint cmake build-essential libtool \
            patch pkg-config ragel subversion unzip git \
            flex python3 wget ninja-build meson nasm yasm \
            libssl-dev

      # æ­¥éª¤ 5: è®¾ç½® Android ç¯å¢ƒ (SDK & NDK)
      - name: Setup android sdk and ndk
        uses: android-actions/setup-android@v3
        # æ— éœ€é¢å¤–é…ç½®ï¼ŒActionä¼šè‡ªåŠ¨è®¾ç½®æœ€æ–°çš„ç¨³å®šç‰ˆå‘½ä»¤è¡Œå·¥å…·å’ŒNDK
        # å¹¶æ¥å—è®¸å¯åè®®ã€‚

      # æ­¥éª¤ 6: é…ç½®é¡¹ç›®æ„å»ºç¯å¢ƒ
      - name: Configure project environment
        run: |
          cd "${{ env.BUILD_DIR }}"
          echo "ğŸ› ï¸  Configuring build environment..."

          # 1. åˆ›å»º local.propertiesï¼ŒæŒ‡å‘ CI ç¯å¢ƒä¸­çš„ SDK/NDK
          echo "sdk.dir=$ANDROID_SDK" > local.properties
          echo "ndk.dir=$ANDROID_NDK" >> local.properties
          echo "âœ… Created local.properties"

          # 2. ç¡®ä¿ä½¿ç”¨å…¼å®¹çš„ Gradle ç‰ˆæœ¬
          # æ£€æŸ¥å¹¶æ›´æ–° gradle-wrapper.properties æ–‡ä»¶
          WRAPPER_PROPERTIES="gradle/wrapper/gradle-wrapper.properties"
          if [ -f "$WRAPPER_PROPERTIES" ]; then
            echo "ğŸ“„ Updating Gradle wrapper to version ${{ env.GRADLE_VERSION }}"
            sed -i.bak "s|distributionUrl=.*|distributionUrl=https\\\\://services.gradle.org/distributions/gradle-${{ env.GRADLE_VERSION }}-all.zip|" "$WRAPPER_PROPERTIES"
          else
            echo "âš ï¸  Gradle wrapper properties not found, it will be generated by the build script."
          fi

          # 3. ç»™æ„å»ºè„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
          chmod +x buildsystem/compile.sh || true
          echo "âœ… Environment configuration complete."

      # æ­¥éª¤ 7: ä¸º ARM64 æ¶æ„æ„å»º LibVLC
      - name: Build for arm64 (arm64-v8a)
        run: |
          cd "${{ env.BUILD_DIR }}"
          echo "ğŸ—ï¸  Starting RELEASE build for ARM64..."
          # å…³é”®æ„å»ºå‘½ä»¤ï¼š-l ä»…æ„å»º LibVLCï¼Œ-a æŒ‡å®šæ¶æ„ï¼Œ--release å‘å¸ƒæ¨¡å¼
          ./buildsystem/compile.sh -l -a arm64 --release
          echo "âœ… ARM64 build finished."
          
          # æŸ¥æ‰¾ç”Ÿæˆçš„ AAR æ–‡ä»¶ (é€šå¸¸åœ¨ libvlc æ¨¡å—çš„è¾“å‡ºç›®å½•)
          find . -name "*.aar" -type f | head -5 || echo "No AAR files found yet."
          
      # æ­¥éª¤ 8: ä¸º ARMv7 æ¶æ„æ„å»º LibVLC
      - name: Build for armv7 (armeabi-v7a)
        run: |
          cd "${{ env.BUILD_DIR }}"
          echo "ğŸ§¹ Cleaning previous AAR outputs..."
          # æ¸…ç†ä¸Šä¸€æ¬¡æ„å»ºçš„AARè¾“å‡ºï¼Œç¡®ä¿ç‹¬ç«‹æ„å»º
          rm -f libvlcjni/libvlc/build/outputs/aar/*.aar 2>/dev/null || true
          
          echo "ğŸ—ï¸  Starting RELEASE build for ARMv7..."
          ./buildsystem/compile.sh -l -a arm --release
          echo "âœ… ARMv7 build finished."
          
          # å†æ¬¡æŸ¥æ‰¾ AAR æ–‡ä»¶ï¼Œç¡®è®¤ç”Ÿæˆ
          find . -name "*.aar" -type f | head -5 || echo "No AAR files found."

      # æ­¥éª¤ 9: å®šä½å¹¶å‡†å¤‡æ„å»ºäº§ç‰©
      - name: Prepare build artifacts
        run: |
          cd "${{ env.BUILD_DIR }}"
          echo "ğŸ“¦ Preparing build artifacts..."
          
          # åœ¨æ ‡å‡†è¾“å‡ºç›®å½•æŸ¥æ‰¾ Release ç‰ˆæœ¬çš„ AAR
          AAR_DIR="libvlcjni/libvlc/build/outputs/aar"
          if [ -d "$AAR_DIR" ]; then
            echo "Looking in: $AAR_DIR"
            # å¤åˆ¶æ‰€æœ‰æ‰¾åˆ°çš„ AAR åˆ°å·¥ä½œåŒºæ ¹ç›®å½•ä»¥ä¾¿åç»­å¤„ç†
            cp $AAR_DIR/*release*.aar ../ 2>/dev/null || cp $AAR_DIR/*.aar ../ 2>/dev/null || true
          fi
          
          # å›åˆ°å·¥ä½œåŒºæ ¹ç›®å½•æŸ¥çœ‹ç»“æœ
          cd ..
          echo "Found AAR files:"
          ls -la *.aar 2>/dev/null || echo "âš ï¸  No AAR files copied to workspace root."

      # æ­¥éª¤ 10: åˆå¹¶å¤šæ¶æ„ AAR
      - name: Merge multi-abi aar
        run: |
          echo "ğŸ”€ Merging AAR files for multi-ABI support..."
          # æ­¤è„šæœ¬å°†ä¸¤ä¸ªæ¶æ„çš„ .so æ–‡ä»¶åˆå¹¶åˆ°ä¸€ä¸ª AAR åŒ…ä¸­
          # å®ƒæ¥å—ä¸€ä¸ªåŸºç¡€ AAR æ–‡ä»¶åï¼ˆç¬¬ä¸€ä¸ªå‚æ•°ï¼‰å’Œè¦åˆå¹¶çš„å…¶ä»– AAR æ–‡ä»¶
          # è¾“å‡ºä¸º libvlc-release.aar
          /bin/bash -c '
          set -e
          BASE_AAR=""
          for aar in *.aar; do
              if [ -n \"$aar\" ] && [ -f \"$aar\" ]; then
                  if [ -z \"$BASE_AAR\" ]; then
                      BASE_AAR=\"$aar\"
                      echo \"Using $BASE_AAR as base\"
                      mkdir -p merged-aar
                      unzip -q \"$BASE_AAR\" -d merged-aar
                  else
                      echo \"Merging $aar\"
                      mkdir -p temp-merge
                      unzip -q \"$aar\" -d temp-merge
                      # å…³é”®ï¼šåˆå¹¶ jni ç›®å½•ä¸‹çš„åŸç”Ÿåº“
                      if [ -d \"temp-merge/jni\" ]; then
                          cp -rf temp-merge/jni/. merged-aar/jni/ 2>/dev/null || true
                      fi
                      rm -rf temp-merge
                  fi
              fi
          done
          if [ -n \"$BASE_AAR\" ] && [ -d \"merged-aar\" ]; then
              cd merged-aar
              zip -qr ../libvlc-release.aar .
              cd ..
              echo \"âœ… Created merged AAR: libvlc-release.aar\"
              echo \"ğŸ“Š Contents:\"
              unzip -l libvlc-release.aar | grep -E \"(\\.so$|AndroidManifest\\.xml|classes\\.jar)\" | head -20
          else
              echo \"âŒ Failed to create merged AAR. No valid input files?\"
              exit 1
          fi
          '

      # æ­¥éª¤ 11: ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libvlc-build-output
          path: |
            libvlc-release.aar
            *.aar
          retention-days: 7

      # æ­¥éª¤ 12: åˆ›å»º GitHub Release
      - name: Create gitHub release
        uses: softprops/action-gh-release@v1
        if: success()  # ä»…åœ¨æ„å»ºæˆåŠŸæ—¶åˆ›å»ºå‘å¸ƒ
        with:
          tag_name: ${{ github.event.inputs.release_tag }}-$(date +'%Y%m%d-%H%M%S')
          name: "LibVLC AAR - ${{ github.event.inputs.source_branch }}"
          body: |
            Automated build of LibVLC for Android.
            - **Source Branch:** ${{ github.event.inputs.source_branch }}
            - **Build Date:** $(date -u)
            - **Commit:** $(cd ${{ env.BUILD_DIR }} && git log -1 --oneline)
            
            ### Contains AAR for:
            - ARM64-v8a
            - ARMEABI-v7a
            
            ### Usage
            Add the `libvlc-release.aar` file to your project's `libs/` folder and modify your `build.gradle`:
            ```gradle
            dependencies {
                implementation files('libs/libvlc-release.aar')
            }
            ```
          files: |
            libvlc-release.aar
          draft: false
          prerelease: false
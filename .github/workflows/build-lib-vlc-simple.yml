name: Android CI/CD Pipeline
on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  # 阶段1: 环境准备与验证
  setup_env:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.1.1
        
      - name: Setup Java 17
        uses: actions/setup-java@v4.0.0
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: Install specific ndk version
        run: |
          echo "Downloading NDK 25.1.8937393 (VLC-compatible)..."
          cd $ANDROID_SDK_ROOT
          wget -q https://dl.google.com/android/repository/android-ndk-r25b-linux.zip
          unzip -q android-ndk-r25b-linux.zip
          mv android-ndk-r25b ndk/25.1.8937393
          echo "ANDROID_NDK_ROOT=$ANDROID_SDK_ROOT/ndk/25.1.8937393" >> $GITHUB_ENV
          echo "ndkVersion=25.1.8937393" >> $GITHUB_ENV
      
      - name: Verify environment
        run: |
          echo "Java version: $(java -version 2>&1 | head -n 1)"
          echo "NDK version: $(ls $ANDROID_NDK_ROOT | grep '25.1.8937393')"
          echo "Python version: $(python3 --version)"

  # 阶段2: 依赖安装与缓存优化
  install_deps:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.1
      
      - name: Cache Gradle dependencies
        uses: actions/cache@v3.1.3
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      
      - name: Install build dependencies
        run: |
          echo "Installing Python dependencies..."
          python3 -m pip install --upgrade pip
          pip install meson ninja
          
          echo "Setting up Android SDK..."
          yes | $ANDROID_SDK_ROOT/tools/bin/sdkmanager "build-tools;30.0.3" "platforms;android-30"

  # 阶段3: 构建与测试（核心阶段）
  build_and_test:
    runs-on: ubuntu-latest
    needs: [setup_env, install_deps]
    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.1
      
      - name: Configure NDK version
        run: |
          echo "android.ndkVersion=${{ env.ndkVersion }}" >> gradle.properties
          echo "ANDROID_NDK_ROOT=${{ env.ANDROID_NDK_ROOT }}" >> $GITHUB_ENV
      
      - name: Clean intermediate build files
        run: |
          ./gradlew clean
          rm -rf .gradle/caches/  # 彻底清除缓存避免污染
      
      - name: Build arm64-v8a
        run: |
          ./buildsystem/compile.sh -l -a arm64-v8a -t -r --info
          cp vlc-android/libvlcjni/libvlc/build/outputs/aar/*.aar build_artifacts/libs/
      
      - name: Build armeabi-v7a
        run: |
          ./buildsystem/compile.sh -l -a armeabi-v7a -t -r --info
          cp vlc-android/libvlcjni/libvlc/build/outputs/aar/*.aar build_artifacts/libs/
      
      - name: Run unit tests
        run: ./gradlew test --parallel --max-workers=4
      
      - name: Run static analysis
        run: ./gradlew checkstyle pmd lint

  # 阶段4: 产物处理与部署
  deploy:
    runs-on: ubuntu-latest
    needs: build_and_test
    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.1
      
      - name: Merge AAR artifacts
        run: |
          mkdir -p build_artifacts/merged
          find vlc-android -name "*.so" -type f -exec cp {} build_artifacts/merged/ \;
          find vlc-android -name "*.aar" -type f -exec cp {} build_artifacts/merged/ \;
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3.1.3
        with:
          name: AndroidBuildArtifacts
          path: build_artifacts/merged/
      
      - name: Deploy to test environment
        if: github.ref == 'refs/heads/main'
        run: |
          echo "Deploying to test environment..."
          # 实际部署命令（如上传到Firebase Test Lab）

name: build-lib-vlc

on:
  workflow_dispatch:
  workflow_call:

env:
  VLC_REPO_URL: 'https://github.com/videolan/vlc-android.git'
  VLC_BRANCH: 'master'
  AAR_NAME: 'libvlc-release.aar'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Clean runner environment
        run: |
          rm -rf ~/.gradle/caches/transforms-*
          rm -rf ~/.android/build-cache/
    
      - name: Checkout repo
        uses: actions/checkout@main

      - name: Initialization values
        run: |
          echo "BUILD_DATE=$(TZ=UTC-8 date +"%y.%m.%d-%H.%M.%S")" >> $GITHUB_ENV
          
      - name: Setup git config
        run: |
          # 设置 git 用户信息，避免应用补丁时出错
          git config --global user.email "ci@github.com"
          git config --global user.name "GitHub CI"
          
      - name: Setup jdk 17
        uses: actions/setup-java@main
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup android sdk
        uses: android-actions/setup-android@v3

      - name: Install specific ndk version
        run: |
          # VLC 项目需要特定版本的 NDK: 27.0.12077973
          echo "Downloading NDK 27.0.12077973..."
          cd /usr/local/lib/android/sdk
          
          # 下载指定版本的 NDK
          wget -q https://dl.google.com/android/repository/android-ndk-r27-linux.zip
          unzip -q android-ndk-r27-linux.zip
          mv android-ndk-r27 ndk/27.0.12077973
          rm -f android-ndk-r27-linux.zip
          
          # 设置环境变量
          echo "ANDROID_NDK_ROOT=/usr/local/lib/android/sdk/ndk/27.0.12077973" >> $GITHUB_ENV
          echo "ANDROID_NDK=/usr/local/lib/android/sdk/ndk/27.0.12077973" >> $GITHUB_ENV
          
          echo "NDK installed at: /usr/local/lib/android/sdk/ndk/27.0.12077973"
          
      - name: Install build dependencies
        run: |
          echo "Installing build dependencies..."
          sudo apt-get update
          sudo apt-get install -y \
            autoconf \
            automake \
            autopoint \
            cmake \
            gawk \
            build-essential \
            libtool \
            libtool-bin \
            m4 \
            patch \
            pkg-config \
            protobuf-compiler \
            ragel \
            subversion \
            unzip \
            ant \
            openjdk-8-jre \
            openjdk-8-jdk \
            flex \
            python3 \
            python3-pip \
            python3-setuptools \
            wget \
            curl \
            git \
            make \
            gcc \
            g++ \
            yasm \
            nasm \
            gperf \
            bison \
            lzip \
            ninja-build \
            meson \
            libc6-dev-i386 \
            gcc-multilib \
            g++-multilib \
            rsync
            
          pip3 install meson
            
      - name: Configure optimized download settings
        run: |
          echo "Configuring optimized download settings..."
          
          # 安装并配置 aria2 作为下载后端
          sudo apt-get install -y aria2 pv
          
          # 创建优化的 curl 包装器
          cat > /tmp/optimized_curl << 'EOF'
          #!/bin/bash
          
          # 使用 aria2c 替代 curl 进行大文件下载
          use_aria2_for_large_files() {
              local url=""
              local output=""
              local other_args=()
              local next_is_output=""
              
              # 解析参数
              for arg in "$@"; do
                  if [[ "$arg" == "--output" || "$arg" == "-o" ]]; then
                      next_is_output=1
                  elif [ -n "$next_is_output" ]; then
                      output="$arg"
                      next_is_output=""
                  elif [[ "$arg" =~ ^https?:// ]]; then
                      url="$arg"
                  else
                      other_args+=("$arg")
                  fi
              done
              
              # 如果是下载大文件且指定了输出文件，使用 aria2
              if [ -n "$url" ] && [ -n "$output" ] && [[ "$url" =~ \.(tar\.gz|tar\.bz2|zip|tgz|gz)$ ]]; then
                  echo "Using aria2c for optimized download: $url -> $output"
                  aria2c \
                    --max-connection-per-server=8 \
                    --split=8 \
                    --min-split-size=1M \
                    --retry-wait=2 \
                    --max-tries=5 \
                    --timeout=30 \
                    --connect-timeout=30 \
                    --allow-overwrite=true \
                    --auto-file-renaming=false \
                    --check-certificate=false \
                    --user-agent="Mozilla/5.0" \
                    --out="$output" \
                    "$url"
                  return $?
              fi
              
              # 否则使用原来的 curl
              /usr/bin/curl_original "$@"
          }
          
          use_aria2_for_large_files "$@"
          EOF
          
          # 备份并替换 curl
          sudo cp /usr/bin/curl /usr/bin/curl_original
          sudo cp /tmp/optimized_curl /usr/bin/curl
          sudo chmod +x /usr/bin/curl
          
          # 创建优化的 wget 包装器
          cat > /tmp/optimized_wget << 'EOF'
          #!/bin/bash
          
          # 使用 aria2c 替代 wget 进行大文件下载
          use_aria2_for_large_files() {
              local url=""
              local output=""
              local other_args=()
              local next_is_output=""
              
              # 解析参数
              for arg in "$@"; do
                  if [[ "$arg" == "--output-document" || "$arg" == "-O" ]]; then
                      next_is_output=1
                  elif [ -n "$next_is_output" ]; then
                      output="$arg"
                      next_is_output=""
                  elif [[ "$arg" =~ ^https?:// ]]; then
                      url="$arg"
                  else
                      other_args+=("$arg")
                  fi
              done
              
              # 如果是下载大文件且指定了输出文件，使用 aria2
              if [ -n "$url" ] && [ -n "$output" ] && [[ "$url" =~ \.(tar\.gz|tar\.bz2|zip|tgz|gz)$ ]]; then
                  echo "Using aria2c for optimized download: $url -> $output"
                  aria2c \
                    --max-connection-per-server=8 \
                    --split=8 \
                    --min-split-size=1M \
                    --retry-wait=2 \
                    --max-tries=5 \
                    --timeout=30 \
                    --connect-timeout=30 \
                    --allow-overwrite=true \
                    --auto-file-renaming=false \
                    --check-certificate=false \
                    --user-agent="Mozilla/5.0" \
                    --out="$output" \
                    "$url"
                  return $?
              fi
              
              # 否则使用原来的 wget
              /usr/bin/wget_original "$@"
          }
          
          use_aria2_for_large_files "$@"
          EOF
          
          # 备份并替换 wget
          sudo cp /usr/bin/wget /usr/bin/wget_original
          sudo cp /tmp/optimized_wget /usr/bin/wget
          sudo chmod +x /usr/bin/wget
          
          # 设置 aria2 的配置文件
          mkdir -p ~/.aria2
          cat > ~/.aria2/aria2.conf << 'EOF'
          # 下载设置
          max-concurrent-downloads=5
          max-connection-per-server=8
          split=8
          min-split-size=1M
          
          # 重试设置
          retry-wait=2
          max-tries=5
          timeout=30
          connect-timeout=30
          
          # 其他设置
          allow-overwrite=true
          auto-file-renaming=false
          check-certificate=false
          user-agent=Mozilla/5.0
          
          # 速度限制（无限制）
          max-overall-download-limit=0
          max-download-limit=0
          
          # 磁盘缓存
          disk-cache=32M
          file-allocation=prealloc
          EOF
          
          echo "Download optimization configured"
          
      - name: Pre-download VLC build dependencies
        run: |
          echo "Pre-downloading VLC build dependencies..."
          
          # 下载 protobuf 3.1.0
          echo "Downloading protobuf-3.1.0.tar.gz..."
          if [ ! -f /tmp/protobuf-3.1.0.tar.gz ]; then
            aria2c \
              --max-connection-per-server=8 \
              --split=8 \
              --min-split-size=1M \
              --retry-wait=2 \
              --max-tries=5 \
              --timeout=30 \
              --connect-timeout=30 \
              --allow-overwrite=true \
              --auto-file-renaming=false \
              --check-certificate=false \
              --user-agent="Mozilla/5.0" \
              --out="/tmp/protobuf-3.1.0.tar.gz" \
              "https://github.com/protocolbuffers/protobuf/releases/download/v3.1.0/protobuf-cpp-3.1.0.tar.gz"
          fi
          
          # 下载 meson 0.63.0
          echo "Downloading meson-0.63.0.tar.gz..."
          if [ ! -f /tmp/meson-0.63.0.tar.gz ]; then
            aria2c \
              --max-connection-per-server=8 \
              --split=8 \
              --min-split-size=1M \
              --retry-wait=2 \
              --max-tries=5 \
              --timeout=30 \
              --connect-timeout=30 \
              --allow-overwrite=true \
              --auto-file-renaming=false \
              --check-certificate=false \
              --user-agent="Mozilla/5.0" \
              --out="/tmp/meson-0.63.0.tar.gz" \
              "https://github.com/mesonbuild/meson/releases/download/0.63.0/meson-0.63.0.tar.gz"
          fi
          
          echo "Pre-download completed"
            
      - name: Clone vlc android repository
        run: |
          cd "$GITHUB_WORKSPACE"
          echo "Cloning VLC Android repository from ${{ env.VLC_REPO_URL }}"
          git clone --depth 1 --branch ${{ env.VLC_BRANCH }} ${{ env.VLC_REPO_URL }} vlc-android
          
      - name: Pre-populate dependencies cache
        run: |
          echo "Pre-populating VLC dependencies cache..."
          cd "$GITHUB_WORKSPACE"/vlc-android
          
          # 确保 extras/tools 目录存在
          mkdir -p libvlcjni/vlc/extras/tools
          
          # 复制预下载的依赖文件
          if [ -f /tmp/protobuf-3.1.0.tar.gz ]; then
            echo "Copying protobuf-3.1.0.tar.gz to extras/tools/"
            cp /tmp/protobuf-3.1.0.tar.gz libvlcjni/vlc/extras/tools/
          fi
          
          if [ -f /tmp/meson-0.63.0.tar.gz ]; then
            echo "Copying meson-0.63.0.tar.gz to extras/tools/"
            cp /tmp/meson-0.63.0.tar.gz libvlcjni/vlc/extras/tools/
          fi
          
          echo "Cache population completed"
          
      - name: Setup environment variables
        run: |
          cd "$GITHUB_WORKSPACE"/vlc-android
          
          # 设置环境变量（根据 compile.sh 的要求）
          export ANDROID_SDK="$ANDROID_HOME"
          export ANDROID_NDK="$ANDROID_NDK_ROOT"
          
          # 创建本地配置文件
          echo "sdk.dir=$ANDROID_HOME" > local.properties
          echo "ndk.dir=$ANDROID_NDK_ROOT" >> local.properties
          
          echo "Environment variables set:"
          echo "ANDROID_SDK=$ANDROID_SDK"
          echo "ANDROID_NDK=$ANDROID_NDK"
          
          # 将这些变量导出到后续步骤
          echo "ANDROID_SDK=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ANDROID_NDK=$ANDROID_NDK_ROOT" >> $GITHUB_ENV
          
      - name: Build libvlc for arm64-v8a architecture
        run: |
          cd "$GITHUB_WORKSPACE"/vlc-android
          
          echo "Current directory: $(pwd)"
          
          # 设置环境变量
          export ANDROID_SDK="$ANDROID_HOME"
          export ANDROID_NDK="$ANDROID_NDK_ROOT"
          
          echo "ANDROID_SDK: $ANDROID_SDK"
          echo "ANDROID_NDK: $ANDROID_NDK"
          
          # 检查 buildsystem 目录和脚本
          echo "Checking buildsystem directory..."
          ls -la buildsystem/
          
          # 使构建脚本可执行
          chmod +x buildsystem/compile.sh
          chmod +x buildsystem/compile-medialibrary.sh
          chmod +x buildsystem/compile-remoteaccess.sh
          
          # 检查脚本是否存在
          if [ -f "buildsystem/compile.sh" ]; then
            echo "✓ Found compile.sh in buildsystem/"
          else
            echo "✗ compile.sh not found in buildsystem/"
            find . -name "compile.sh" -type f
            exit 1
          fi
          
          # 根据 README 和 compile.sh，构建 libVLC 使用 -l 参数
          # 使用 -a arm64-v8a 构建 arm64 架构
          # 使用 -t 尝试使用预构建的 contribs（加速构建）
          # 使用 -r 构建 release 版本
          
          echo "Starting libVLC build for arm64-v8a..."
          echo "This may take a while (15-20 minutes)..."
          
          # 构建 arm64-v8a 架构的 libVLC
          # 使用 -b 参数绕过版本检查（如果需要）
          ./buildsystem/compile.sh -l -a arm64-v8a -t -r -b
          
          echo "arm64-v8a build completed!"
          
          # 备份 arm64-v8a 的构建结果
          echo "Backing up arm64-v8a build artifacts..."
          mkdir -p "$GITHUB_WORKSPACE/build_artifacts/arm64-v8a"
          
          # 查找并复制 AAR 文件
          find . -name "*.aar" -type f 2>/dev/null | head -5 | while read file; do
            echo "Found AAR for arm64-v8a: $file"
            cp "$file" "$GITHUB_WORKSPACE/build_artifacts/arm64-v8a/"
          done
          
          # 查找并复制 so 文件
          find . -name "*.so" -type f 2>/dev/null | head -20 | while read file; do
            echo "Found .so for arm64-v8a: $file"
            # 提取架构信息
            if echo "$file" | grep -q "arm64-v8a"; then
              arch="arm64-v8a"
            elif echo "$file" | grep -q "armeabi-v7a"; then
              arch="armeabi-v7a"
            elif echo "$file" | grep -q "x86"; then
              arch="x86"
            elif echo "$file" | grep -q "x86_64"; then
              arch="x86_64"
            else
              arch="unknown"
            fi
            mkdir -p "$GITHUB_WORKSPACE/build_artifacts/libs/$arch"
            cp "$file" "$GITHUB_WORKSPACE/build_artifacts/libs/$arch/"
          done
          
      - name: Clean intermediate build files
        run: |
          cd "$GITHUB_WORKSPACE"/vlc-android
          
          echo "Cleaning intermediate build files for next architecture..."
          
          # 清理一些中间文件，但保留下载的依赖
          # 这样可以加快第二个架构的构建
          if [ -d "libvlcjni/libvlc/build" ]; then
            echo "Cleaning libvlc build directory..."
            rm -rf libvlcjni/libvlc/build/outputs
            rm -rf libvlcjni/libvlc/build/intermediates
            rm -rf libvlcjni/libvlc/build/tmp
          fi
          
          if [ -d "libvlcjni/vlc/build-android-" ]; then
            echo "Cleaning vlc build directories..."
            rm -rf libvlcjni/vlc/build-android-*
          fi
          
          # 清理 gradle 缓存
          if [ -d ".gradle" ]; then
            echo "Cleaning gradle cache..."
            rm -rf .gradle/caches
            rm -rf .gradle/daemon
          fi
          
      - name: Build libvlc for armeabi-v7a architecture
        run: |
          cd "$GITHUB_WORKSPACE"/vlc-android
          
          echo "Current directory: $(pwd)"
          
          # 设置环境变量
          export ANDROID_SDK="$ANDROID_HOME"
          export ANDROID_NDK="$ANDROID_NDK_ROOT"
          
          echo "ANDROID_SDK: $ANDROID_SDK"
          echo "ANDROID_NDK: $ANDROID_NDK"
          
          # 根据 README 和 compile.sh，构建 libVLC 使用 -l 参数
          # 使用 -a armeabi-v7a 构建 arm 架构
          # 使用 -t 尝试使用预构建的 contribs（加速构建）
          # 使用 -r 构建 release 版本
          
          echo "Starting libVLC build for armeabi-v7a..."
          echo "This may take a while (15-20 minutes)..."
          
          # 构建 armeabi-v7a 架构的 libVLC
          ./buildsystem/compile.sh -l -a armeabi-v7a -t -r -b
          
          echo "armeabi-v7a build completed!"
          
          # 备份 armeabi-v7a 的构建结果
          echo "Backing up armeabi-v7a build artifacts..."
          mkdir -p "$GITHUB_WORKSPACE/build_artifacts/armeabi-v7a"
          
          # 查找并复制 AAR 文件
          find . -name "*.aar" -type f 2>/dev/null | head -5 | while read file; do
            echo "Found AAR for armeabi-v7a: $file"
            cp "$file" "$GITHUB_WORKSPACE/build_artifacts/armeabi-v7a/"
          done
          
          # 查找并复制 so 文件
          find . -name "*.so" -type f 2>/dev/null | head -20 | while read file; do
            echo "Found .so for armeabi-v7a: $file"
            # 提取架构信息
            if echo "$file" | grep -q "arm64-v8a"; then
              arch="arm64-v8a"
            elif echo "$file" | grep -q "armeabi-v7a"; then
              arch="armeabi-v7a"
            elif echo "$file" | grep -q "x86"; then
              arch="x86"
            elif echo "$file" | grep -q "x86_64"; then
              arch="x86_64"
            else
              arch="unknown"
            fi
            mkdir -p "$GITHUB_WORKSPACE/build_artifacts/libs/$arch"
            cp "$file" "$GITHUB_WORKSPACE/build_artifacts/libs/$arch/"
          done
          
      - name: Merge multi-architecture AAR
        run: |
          cd "$GITHUB_WORKSPACE"
          
          echo "Merging multi-architecture AAR files..."
          
          # 首先找到最新的 AAR 文件（应该是 armeabi-v7a 构建的）
          BASE_AAR=""
          if [ -d "build_artifacts/armeabi-v7a" ]; then
            BASE_AAR=$(find build_artifacts/armeabi-v7a -name "*.aar" -type f 2>/dev/null | head -1)
          fi
          
          if [ -z "$BASE_AAR" ] && [ -d "build_artifacts/arm64-v8a" ]; then
            BASE_AAR=$(find build_artifacts/arm64-v8a -name "*.aar" -type f 2>/dev/null | head -1)
          fi
          
          if [ -n "$BASE_AAR" ] && [ -f "$BASE_AAR" ]; then
            echo "Found base AAR: $BASE_AAR"
            
            # 创建临时目录
            TEMP_DIR=$(mktemp -d)
            echo "Using temp directory: $TEMP_DIR"
            
            # 解压基础 AAR
            echo "Extracting base AAR..."
            unzip -q "$BASE_AAR" -d "$TEMP_DIR"
            
            # 确保 jni 目录存在
            mkdir -p "$TEMP_DIR/jni"
            
            # 复制 arm64-v8a 的 so 文件
            if [ -d "build_artifacts/libs/arm64-v8a" ]; then
              echo "Copying arm64-v8a libraries..."
              mkdir -p "$TEMP_DIR/jni/arm64-v8a"
              # 只复制 .so 文件，忽略其他文件
              find "build_artifacts/libs/arm64-v8a" -name "*.so" -type f | while read so_file; do
                cp "$so_file" "$TEMP_DIR/jni/arm64-v8a/"
              done
              echo "Copied $(ls -1 "$TEMP_DIR/jni/arm64-v8a/" 2>/dev/null | wc -l) arm64-v8a libraries"
            fi
            
            # 复制 armeabi-v7a 的 so 文件
            if [ -d "build_artifacts/libs/armeabi-v7a" ]; then
              echo "Copying armeabi-v7a libraries..."
              mkdir -p "$TEMP_DIR/jni/armeabi-v7a"
              # 只复制 .so 文件，忽略其他文件
              find "build_artifacts/libs/armeabi-v7a" -name "*.so" -type f | while read so_file; do
                cp "$so_file" "$TEMP_DIR/jni/armeabi-v7a/"
              done
              echo "Copied $(ls -1 "$TEMP_DIR/jni/armeabi-v7a/" 2>/dev/null | wc -l) armeabi-v7a libraries"
            fi
            
            # 创建合并后的 AAR
            echo "Creating merged AAR..."
            cd "$TEMP_DIR"
            zip -qr "$GITHUB_WORKSPACE/libvlc-release.aar" .
            
            echo "Merged AAR created: $GITHUB_WORKSPACE/libvlc-release.aar"
            echo "File size: $(du -h "$GITHUB_WORKSPACE/libvlc-release.aar" | cut -f1)"
            
            # 清理临时目录
            rm -rf "$TEMP_DIR"
          else
            echo "✗ Error: Could not find a valid AAR file to use as base"
            echo "Searching for AAR files in vlc-android directory..."
            find "$GITHUB_WORKSPACE/vlc-android" -name "*.aar" -type f 2>/dev/null | head -10
            exit 1
          fi
          
      - name: Verify multi-architecture aar file
        run: |
          cd "$GITHUB_WORKSPACE"
          
          if [ -f "libvlc-release.aar" ]; then
            echo "✓ Multi-architecture AAR file found and verified"
            echo "File size: $(du -h libvlc-release.aar | cut -f1)"
            echo "File type:"
            file libvlc-release.aar
            
            # 检查 AAR 文件内容
            echo "AAR contents overview:"
            unzip -l libvlc-release.aar | head -30
            
            # 检查是否包含原生库
            echo "Checking for native libraries..."
            if unzip -l libvlc-release.aar | grep -q "\.so$"; then
              echo "✓ AAR contains native libraries (.so files)"
              # 显示包含的架构
              echo "Architectures found in AAR:"
              unzip -l libvlc-release.aar | grep "\.so$" | sed 's/.*\/jni\/\([^/]*\)\/.*/\1/' | sort | uniq
              
              # 统计每个架构的 so 文件数量
              echo "Number of .so files per architecture:"
              for arch in arm64-v8a armeabi-v7a x86 x86_64; do
                count=$(unzip -l libvlc-release.aar | grep -c "jni/$arch/.*\.so$" || true)
                if [ "$count" -gt 0 ]; then
                  echo "  $arch: $count files"
                fi
              done
            else
              echo "⚠ AAR does not contain native libraries"
              # 列出 AAR 中的所有文件
              echo "Listing all files in AAR:"
              unzip -l libvlc-release.aar
            fi
            
            # 检查 AndroidManifest
            echo "Checking for AndroidManifest..."
            if unzip -l libvlc-release.aar | grep -q "AndroidManifest.xml"; then
              echo "✓ AAR contains AndroidManifest.xml"
            fi
            
            # 检查 classes.jar
            echo "Checking for classes.jar..."
            if unzip -l libvlc-release.aar | grep -q "classes.jar"; then
              echo "✓ AAR contains classes.jar"
            fi
          else
            echo "✗ Error: No AAR file found at $GITHUB_WORKSPACE/libvlc-release.aar"
            
            # 输出一些调试信息
            echo "Listing build artifacts:"
            find "$GITHUB_WORKSPACE/build_artifacts" -type f 2>/dev/null | head -30
            
            # 检查各个架构的构建结果
            echo "Checking individual architecture builds:"
            for arch in arm64-v8a armeabi-v7a; do
              if [ -d "$GITHUB_WORKSPACE/build_artifacts/$arch" ]; then
                echo "  $arch directory contents:"
                ls -la "$GITHUB_WORKSPACE/build_artifacts/$arch/" 2>/dev/null || echo "    No files"
              fi
            done
            
            # 检查 libs 目录
            if [ -d "$GITHUB_WORKSPACE/build_artifacts/libs" ]; then
              echo "libs directory contents:"
              find "$GITHUB_WORKSPACE/build_artifacts/libs" -type f 2>/dev/null | head -20
            fi
            
            exit 1
          fi
          
      - name: Create github release
        uses: softprops/action-gh-release@master
        with:
          tag_name: ${{env.BUILD_DATE}}-vlclib
          files: |
            ${{ github.workspace }}/libvlc-release.aar
          draft: false
          prerelease: false

      # - name: Push vlc aar to bv-libs repository
      #   env:
      #     TARGET_REPO: "git@github.com:zxgv5/bv-libs.git"
      #   run: |
      #     # 设置 SSH 密钥和配置
      #     echo "Setting up SSH configuration..."
      #     mkdir -p ~/.ssh
      #     chmod 700 ~/.ssh
      #     
      #     # 写入私钥
      #     echo "${{ secrets.BV_LIBS_DEPLOY_KEY }}" > ~/.ssh/id_ed25519
      #     chmod 600 ~/.ssh/id_ed25519
      #     
      #     # 配置 SSH 不验证主机
      #     echo "Host github.com" >> ~/.ssh/config
      #     echo "  StrictHostKeyChecking no" >> ~/.ssh/config
      #     echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config
      #     chmod 600 ~/.ssh/config
      #     
      #     # 测试 SSH 连接
      #     echo "Testing SSH connection to GitHub..."
      #     ssh -T git@github.com 2>&1 | grep -v "successfully authenticated" || true
      #     
      #     # 设置 Git 配置
      #     git config --global user.name "GitHub Actions"
      #     git config --global user.email "actions@github.com"
      #     git config --global init.defaultBranch main
      #     
      #     # 克隆目标仓库
      #     cd "$GITHUB_WORKSPACE"
      #     echo "Cloning target repository: ${{ env.TARGET_REPO }}"
      #     git clone ${{ env.TARGET_REPO }} target-repo
      #     cd target-repo
      #     
      #     # 确保在 main 分支
      #     git checkout main
      #     
      #     # 复制新的 AAR 文件到目标位置
      #     SOURCE_AAR="$GITHUB_WORKSPACE/libvlc-release.aar"
      #     TARGET_DIR="libVLC"
      #     
      #     # 检查 AAR 文件是否存在
      #     if [ -f "$SOURCE_AAR" ]; then
      #       echo "✓ Found AAR file: $SOURCE_AAR"
      #       
      #       # 确保目标目录存在
      #       mkdir -p "$TARGET_DIR"
      #       
      #       # 复制新文件
      #       echo "Copying new AAR file..."
      #       cp -v "$SOURCE_AAR" "$TARGET_DIR/libvlc-release.aar"
      #       
      #       # 提交更改
      #       echo "Committing changes..."
      #       git add "$TARGET_DIR/libvlc-release.aar"
      #       
      #       # 检查是否有更改
      #       if git diff --cached --quiet; then
      #         echo "No changes to commit."
      #       else
      #         git commit -m "Update VLC AAR (multi-arch: arm64+v7a) - ${{ env.BUILD_DATE }} [CI]"
      #         echo "Pushing to remote repository..."
      #         git push origin main
      #         echo "✓ Successfully pushed multi-architecture VLC AAR to ${{ env.TARGET_REPO }}"
      #       fi
      #     else
      #       echo "✗ Error: AAR file not found at $SOURCE_AAR"
      #       exit 1
      #     fi
      #     
      #     # 清理 SSH 密钥
      #     rm -f ~/.ssh/id_ed25519
      #     rm -f ~/.ssh/config

      # 可选：缓存构建结果以加速后续构建
      # - name: Cache build artifacts
      #   uses: actions/cache@v3
      #   with:
      #     path: |
      #       ~/.gradle/caches
      #       ~/.gradle/wrapper
      #       vlc-android/.gradle
      #       vlc-android/libvlcjni/vlc/contrib
      #     key: ${{ runner.os }}-vlc-build-${{ hashFiles('vlc-android/compile.sh', 'vlc-android/build.gradle') }}
      #     restore-keys: |
      #       ${{ runner.os }}-vlc-build-
name: build-termux

on:
  workflow_dispatch:  # 允许手动触发发布
    inputs:
      release_version:
        description: '发布版本号 (例如: v0.118.0)'
        required: true
        default: 'v0.119.0'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    env:
      # 使用 apt-android-7 变体（根据需求可选择其他变体）
      PACKAGE_VARIANT: apt-android-7
      # 只构建 arm64-v8a 架构
      BUILD_ABI: arm64-v8a
      # 构建类型设为 release
      BUILD_TYPE: release
      # 源代码目录
      SOURCE_DIR: termux-app-source
      # gh token
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    steps:
      - name: Clone termux-app repository
        uses: actions/checkout@main
        with:
          repository: termux/termux-app
          ref: master
          path: ${{ env.SOURCE_DIR }}
      
      # - name: Set up JDK 17
      #   uses: actions/setup-java@main
      #   with:
      #     distribution: 'temurin'
      #     java-version: '17'
      
      # - name: Set up Android SDK
      #   uses: android-actions/setup-android@main
      
      - name: Decode Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          if [ -z "$KEYSTORE_BASE64" ]; then
            echo "错误: KEYSTORE_BASE64 secret 未设置"
            exit 1
          fi
          
          # 创建目录并解码密钥库
          mkdir -p ./keystore
          echo "$KEYSTORE_BASE64" | base64 --decode > ./keystore/release-keystore.p12
          
          # 验证文件是否创建成功
          if [ ! -f "./keystore/release-keystore.p12" ]; then
            echo "错误: 密钥库文件创建失败"
            exit 1
          fi
          
          echo "密钥库已成功解码到 ./keystore/release-keystore.p12"
      
      - name: Set version from tag or input
        id: set_version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # 手动触发时使用输入版本
            VERSION="${{ github.event.inputs.release_version }}"
            echo "使用手动输入的版本: $VERSION"
          else
            # 标签触发时使用标签名
            VERSION="${GITHUB_REF#refs/tags/}"
            echo "使用标签版本: $VERSION"
          fi
          
          # 移除版本号前的 'v' 前缀（如果需要）
          VERSION_WITHOUT_V="${VERSION#v}"
          echo "version_without_v=$VERSION_WITHOUT_V" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          echo "最终版本: $VERSION_WITHOUT_V"
      
      - name: Build and Sign Release APK
        working-directory: ${{ env.SOURCE_DIR }}
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_ALIAS_PASSWORD: ${{ secrets.KEY_ALIAS_PASSWORD }}
        run: |
          # 验证必要的环境变量
          if [ -z "$KEYSTORE_PASSWORD" ] || [ -z "$KEY_ALIAS" ] || [ -z "$KEY_ALIAS_PASSWORD" ]; then
            echo "错误: 签名所需的密钥密码或别名未设置"
            exit 1
          fi
          
          echo "正在构建 Release APK..."
          echo "版本: ${{ steps.set_version.outputs.version_without_v }}"
          echo "变体: ${{ env.PACKAGE_VARIANT }}"
          echo "架构: ${{ env.BUILD_ABI }}"
          echo "构建类型: ${{ env.BUILD_TYPE }}"
          
          # 将密钥库从工作空间根目录复制到源代码目录
          cp ../keystore/release-keystore.p12 ./
          
          # 设置构建变量
          export TERMUX_APP_VERSION_NAME="${{ steps.set_version.outputs.version_without_v }}"
          export TERMUX_APK_VERSION_TAG="${{ steps.set_version.outputs.version }}-${{ env.PACKAGE_VARIANT }}-github-release"
          export TERMUX_PACKAGE_VARIANT="${{ env.PACKAGE_VARIANT }}"
          
          # 构建 Release 版本
          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file=./release-keystore.p12 \
            -Pandroid.injected.signing.store.password="$KEYSTORE_PASSWORD" \
            -Pandroid.injected.signing.key.alias="$KEY_ALIAS" \
            -Pandroid.injected.signing.key.password="$KEY_ALIAS_PASSWORD" \
            -PbuildABI="${{ env.BUILD_ABI }}"
          
          echo "构建完成!"
      
      - name: Verify APK
        working-directory: ${{ env.SOURCE_DIR }}
        run: |
          RELEASE_DIR="./app/build/outputs/apk/release"
          APK_PREFIX="termux-app_${{ steps.set_version.outputs.version }}-${{ env.PACKAGE_VARIANT }}-github-release"
          
          # 检查 APK 文件是否存在
          APK_PATH="$RELEASE_DIR/${APK_PREFIX}_${{ env.BUILD_ABI }}.apk"
          echo "检查 APK 文件: $APK_PATH"
          
          if [ ! -f "$APK_PATH" ]; then
            echo "错误: APK 文件未找到"
            ls -la "$RELEASE_DIR" || true
            exit 1
          fi
          
          # 显示 APK 信息
          echo "APK 文件大小: $(du -h "$APK_PATH" | cut -f1)"
          
          # 验证 APK 签名
          echo "验证 APK 签名..."
          if command -v apksigner &> /dev/null; then
            apksigner verify --verbose "$APK_PATH" || {
              echo "警告: apksigner 验证失败"
            }
          else
            echo "警告: apksigner 未安装，尝试使用 jarsigner 验证..."
            jarsigner -verify -verbose "$APK_PATH" || echo "签名验证失败"
          fi
          
          # 将 APK 复制到工作流根目录以便后续步骤使用
          mkdir -p ../release-artifacts
          cp "$APK_PATH" ../release-artifacts/
          
          # 设置输出变量
          echo "APK_PATH=../release-artifacts/$(basename "$APK_PATH")" >> $GITHUB_ENV
          echo "APK_FILENAME=$(basename "$APK_PATH")" >> $GITHUB_ENV
      
      - name: Generate SHA256 Checksum
        run: |
          CHECKSUM_FILE="./release-artifacts/checksums.sha256"
          echo "生成 SHA256 校验和..."
          
          sha256sum "${{ env.APK_PATH }}" > "$CHECKSUM_FILE"
          cat "$CHECKSUM_FILE"
          
          echo "CHECKSUM_FILE=$CHECKSUM_FILE" >> $GITHUB_ENV
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@master
        with:
          name: Termux ${{ steps.set_version.outputs.version }}
          tag_name: ${{ steps.set_version.outputs.version }}
          draft: false
          prerelease: false
          files: |
            ${{ env.APK_PATH }}
            ${{ env.CHECKSUM_FILE }}
          body: |
            # Termux ${{ steps.set_version.outputs.version }}
            
            ## 发布信息
            - **版本**: ${{ steps.set_version.outputs.version }}
            - **变体**: ${{ env.PACKAGE_VARIANT }}
            - **架构**: ${{ env.BUILD_ABI }}
            - **构建类型**: ${{ env.BUILD_TYPE }}
            - **源代码**: termux/termux-app 的 master 分支
            
            ## 安装说明
            1. 下载 APK 文件
            2. 验证 SHA256 校验和
            3. 在 Android 设备上安装
            
            ## 校验和
            ```
            $(cat ${{ env.CHECKSUM_FILE }})
            ```
            
            ## 注意事项
            - 此版本仅支持 arm64-v8a 架构设备
            - 安装前请确保已卸载旧版本
            
            ## 变更记录
            ${{ github.event.head_commit.message }}

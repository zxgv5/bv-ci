name: Push aar to bv-libs
# 定义可复用工作流的触发方式（仅被其他工作流调用）
on:
  workflow_call:
    # 定义外部可传入的参数（必选/可选+默认值）
    inputs:
      SOURCE_AAR:
        description: "源AAR文件的完整路径（如 $GITHUB_WORKSPACE/libvlc-release.aar）"
        required: true
        type: string
      TARGET_NAME:
        description: "目标库名称（如 libvlc）"
        required: true
        type: string
      TARGET_DIR:
        description: "目标仓库中的目录（如 libVLC）"
        required: true
        type: string
      TARGET_AAR:
        description: "目标AAR文件名（如 libvlc-release.aar）"
        required: true
        type: string
      TARGET_REPO:
        description: "目标仓库的SSH地址"
        required: false
        type: string
        default: "git@github.com:zxgv5/bv-libs.git"
      BUILD_DATE:
        description: "构建日期（用于commit信息）"
        required: false
        type: string
        default: ${{ github.run_id }} # 默认用运行ID，也可外部传入

    # 定义需要传递的密钥（外部调用时必须提供）
    secrets:
      BV_LIBS_DEPLOY_KEY:
        description: "推送bv-libs仓库的SSH私钥"
        required: true

# 核心执行任务
jobs:
  push-aar-to-bv-libs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repo
        uses: actions/checkout@main

      - name: Push aar to bv-libs repository
        env:
          # 从输入参数/密钥中赋值环境变量
          TARGET_REPO: ${{ inputs.TARGET_REPO }}
          SOURCE_AAR: ${{ inputs.SOURCE_AAR }}
          TARGET_NAME: ${{ inputs.TARGET_NAME }}
          TARGET_DIR: ${{ inputs.TARGET_DIR }}
          TARGET_AAR: ${{ inputs.TARGET_AAR }}
          BUILD_DATE: ${{ inputs.BUILD_DATE }}
          BV_LIBS_DEPLOY_KEY: ${{ secrets.BV_LIBS_DEPLOY_KEY }}
        run: |
          # 设置 SSH 密钥和配置
          echo "Setting up SSH configuration..."
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # 写入私钥
          echo "${BV_LIBS_DEPLOY_KEY}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          # 配置 SSH 不验证主机
          echo "Host github.com" >> ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config
          echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config
          chmod 600 ~/.ssh/config
          # 测试 SSH 连接
          echo "Testing SSH connection to GitHub..."
          ssh -T git@github.com 2>&1 | grep -v "successfully authenticated" || true
          # 设置 Git 配置
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git config --global init.defaultBranch main
          # 克隆目标仓库
          cd "$GITHUB_WORKSPACE"
          echo "Cloning target repository: $TARGET_REPO"
          git clone $TARGET_REPO target-repo
          cd target-repo
          # 确保在 main 分支
          git checkout main
          # 检查 aar 文件是否存在
          if [ -f "$SOURCE_AAR" ]; then
            echo "✓ Found aar file: $SOURCE_AAR"
            # 确保目标目录存在
            mkdir -p "$TARGET_DIR"
            # 复制新文件
            echo "Copying new aar file..."
            cp -v "$SOURCE_AAR" "$TARGET_DIR/$TARGET_AAR"
            # 提交更改
            echo "Committing changes..."
            git add "$TARGET_DIR/$TARGET_AAR"
            # 检查是否有更改
            if git diff --cached --quiet; then
              echo "No changes to commit."
            else
              git commit -m "Update $TARGET_NAME aar - $BUILD_DATE [CI]"
              echo "Pushing to remote repository..."
              git push origin main
              echo "✓ Successfully pushed $TARGET_NAME aar to $TARGET_REPO"
            fi
          else
            echo "✗ Error: aar file not found at $SOURCE_AAR"
            exit 1
          fi
          # 清理 SSH 密钥
          rm -f ~/.ssh/id_ed25519
          rm -f ~/.ssh/config